# 坐标系相关

## 为什么需要转换坐标系？

因为国内对地理坐标有特殊的政策，所有电子地图必须对位置做偏移处理，这导致了从底层接口得到的经纬度坐标展示在地图上会有偏移。这种偏移不是线性的，不能简单地通过加减某个值来校正，并且不同的地图提供商采用的算法也不一样，例如百度地图和高德地图就采用了不同的偏移方式。

## 关于坐标系

我们通常用经纬度来表示一个地理位置，但是由于一些原因，我们从不同渠道得到的经纬度信息可能并不是在同一个坐标系下。

* 高德地图、腾讯地图以及谷歌中国区地图使用的是`GCJ-02`坐标系
* 百度地图使用的是`BD-09`坐标系
* 底层接口(HTML5 Geolocation或ios、安卓API)通过GPS设备获取的坐标使用的是`WGS-84`坐标系

不同的坐标系之间可能有几十到几百米的偏移，所以在开发基于地图的产品，或者做地理数据可视化时，我们需要修正不同坐标系之间的偏差。

### WGS-84 - 世界大地测量系统

`WGS-84`（World Geodetic System, WGS）是使用最广泛的坐标系，也是世界通用的坐标系，GPS设备得到的经纬度就是在`WGS84`坐标系下的经纬度。通常通过底层接口得到的定位信息都是`WGS84`坐标系。

### GCJ-02 - 国测局坐标

`GCJ-02`（G-Guojia国家，C-Cehui测绘，J-Ju局），又被称为火星坐标系，是一种基于`WGS-84`制定的大地测量系统，由中国国测局制定。此坐标系所采用的混淆算法会在经纬度中加入随机的偏移。

国家规定，中国大陆所有公开地理数据都需要至少用`GCJ-02`进行加密，也就是说我们从国内公司的产品中得到的数据，一定是经过了加密的。绝大部分国内互联网地图提供商都是使用`GCJ-02`坐标系，包括高德地图，谷歌地图中国区等。

### BD-09 - 百度坐标系

BD-09（Baidu, BD）是百度地图使用的地理坐标系，其在GCJ-02上多增加了一次变换，用来保护用户隐私。从百度产品中得到的坐标都是BD-09坐标系。

## 相互转换

`GCJ-02`和`BD-09`都是用来对地理数据进行加密的，所以也不会公开逆向转换的方法。理论上，`GCJ-02`的加密过程是不可逆的，但是可以通过一些方法来逼近接原始坐标，并且这种方式的精度很高。开源坐标系处理库[gcoord](https://github.com/hujiulong/gcoord)使用的纠偏方式达到了厘米级的精度，能满足绝大多数情况。

## 经纬度数据处理

前端项目根据实际使用地图情况选择对应的目标坐标系，后端数据库存储统一使用`WGS-84`作为源坐标系。所以前端在提交经纬度相关数据时，必须将经纬度转换为`WGS-84`坐标系后再提交。同理，通过接口获取到的经纬度数据必须转换为前端项目所使用的目标坐标系后再进行展示。

::: danger 特别注意
前端请确保提交的经纬度数据是`WGS-84`坐标系，因为错误的数据一旦入库，将没有其他特征或技术手段可以区分不同坐标系的数据，只能靠人为判断、比对地图清除错误数据。
:::

## 后端为什么需要统一坐标系？

要实现坐标系的转换，必须知道源坐标系和目标坐标系。由于我们数据库没有额外字段记录经纬度的坐标系信息，所以如果后端数据库存储的经纬度没有统一坐标系，前端拿到的数据将无法确定源坐标系是什么，从而无法完成坐标系的转换。

## 如何转换坐标系

为了将坐标系转换逻辑与业务逻辑解耦，框架内部封装了坐标系转换能力，通过[toOriginCoordinate](/utils/coordinate-method.md#toorigincoordinate)、[toTargetCoordinate](/utils/coordinate-method.md#totargetcoordinate)等方法和[transformCoordinate](/http/transform-coordinate.html)参数你无需关心源坐标系和目标坐标系即可快速实现坐标系转换功能。并且项目后期如果后端需要修改坐标系存储规则或前端切换使用的地图，直接修改[环境变量](env)中的源坐标系和目标坐标系配置即可，业务代码无需任何改造。

::: tip 提示
框架内部封装的坐标系转换功能足以应对绝大部分情况，如果你有特殊需求必须手动实现坐标系转换逻辑，可以使用[gcoord](https://github.com/hujiulong/gcoord)库。
:::