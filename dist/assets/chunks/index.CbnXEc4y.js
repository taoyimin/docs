import{a4 as Bt,a5 as ht,a6 as Ut,a7 as Nt,a8 as xt,a9 as Ft,aa as Vt}from"./theme.VUuWSZc_.js";import{_ as de,W as re,A as pe,a as oe,i as Gt,b as be,c as ve,d as Ht,L as tt,e as Ie,V as Ee,f as Pe,N as _e,g as rt,H as ct,h as zt,S as Yt,j as ae,k as wt,l as Dt,M as Tt,r as I,m as ce,n as jt,o as W,p as Ke,t as Kt,q as Xt,s as Wt,u as Ce,E as x,v as ye,w as J,x as ie,T as ft,F as qt,y as ee,B as fe,z as ge,C as Qt,D as $t,G as Jt,I as Zt,J as er,K as tr}from"./fmp4-remuxer.jzJS0tUz.js";import{O as ri}from"./fmp4-remuxer.jzJS0tUz.js";import"./framework._j0QeVG-.js";function rr(u,a){var r=u==null?null:typeof Symbol<"u"&&u[Symbol.iterator]||u["@@iterator"];if(r!=null){var e,t,i,n,s=[],l=!0,o=!1;try{if(i=(r=r.call(u)).next,a===0){if(Object(r)!==r)return;l=!1}else for(;!(l=(e=i.call(r)).done)&&(s.push(e.value),s.length!==a);l=!0);}catch(h){o=!0,t=h}finally{try{if(!l&&r.return!=null&&(n=r.return(),Object(n)!==n))return}finally{if(o)throw t}}return s}}function dt(u,a){var r=Object.keys(u);if(Object.getOwnPropertySymbols){var e=Object.getOwnPropertySymbols(u);a&&(e=e.filter(function(t){return Object.getOwnPropertyDescriptor(u,t).enumerable})),r.push.apply(r,e)}return r}function Y(u){for(var a=1;a<arguments.length;a++){var r=arguments[a]!=null?arguments[a]:{};a%2?dt(Object(r),!0).forEach(function(e){p(u,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(r)):dt(Object(r)).forEach(function(e){Object.defineProperty(u,e,Object.getOwnPropertyDescriptor(r,e))})}return u}function A(){A=function(){return u};var u={},a=Object.prototype,r=a.hasOwnProperty,e=Object.defineProperty||function(y,_,w){y[_]=w.value},t=typeof Symbol=="function"?Symbol:{},i=t.iterator||"@@iterator",n=t.asyncIterator||"@@asyncIterator",s=t.toStringTag||"@@toStringTag";function l(y,_,w){return Object.defineProperty(y,_,{value:w,enumerable:!0,configurable:!0,writable:!0}),y[_]}try{l({},"")}catch{l=function(_,w,L){return _[w]=L}}function o(y,_,w,L){var T=_&&_.prototype instanceof v?_:v,B=Object.create(T.prototype),V=new M(L||[]);return e(B,"_invoke",{value:k(y,w,V)}),B}function h(y,_,w){try{return{type:"normal",arg:y.call(_,w)}}catch(L){return{type:"throw",arg:L}}}u.wrap=o;var c={};function v(){}function f(){}function d(){}var S={};l(S,i,function(){return this});var m=Object.getPrototypeOf,g=m&&m(m(F([])));g&&g!==a&&r.call(g,i)&&(S=g);var D=d.prototype=v.prototype=Object.create(S);function b(y){["next","throw","return"].forEach(function(_){l(y,_,function(w){return this._invoke(_,w)})})}function E(y,_){function w(T,B,V,K){var q=h(y[T],y,B);if(q.type!=="throw"){var C=q.arg,ne=C.value;return ne&&typeof ne=="object"&&r.call(ne,"__await")?_.resolve(ne.__await).then(function(j){w("next",j,V,K)},function(j){w("throw",j,V,K)}):_.resolve(ne).then(function(j){C.value=j,V(C)},function(j){return w("throw",j,V,K)})}K(q.arg)}var L;e(this,"_invoke",{value:function(T,B){function V(){return new _(function(K,q){w(T,B,K,q)})}return L=L?L.then(V,V):V()}})}function k(y,_,w){var L="suspendedStart";return function(T,B){if(L==="executing")throw new Error("Generator is already running");if(L==="completed"){if(T==="throw")throw B;return z()}for(w.method=T,w.arg=B;;){var V=w.delegate;if(V){var K=O(V,w);if(K){if(K===c)continue;return K}}if(w.method==="next")w.sent=w._sent=w.arg;else if(w.method==="throw"){if(L==="suspendedStart")throw L="completed",w.arg;w.dispatchException(w.arg)}else w.method==="return"&&w.abrupt("return",w.arg);L="executing";var q=h(y,_,w);if(q.type==="normal"){if(L=w.done?"completed":"suspendedYield",q.arg===c)continue;return{value:q.arg,done:w.done}}q.type==="throw"&&(L="completed",w.method="throw",w.arg=q.arg)}}}function O(y,_){var w=_.method,L=y.iterator[w];if(L===void 0)return _.delegate=null,w==="throw"&&y.iterator.return&&(_.method="return",_.arg=void 0,O(y,_),_.method==="throw")||w!=="return"&&(_.method="throw",_.arg=new TypeError("The iterator does not provide a '"+w+"' method")),c;var T=h(L,y.iterator,_.arg);if(T.type==="throw")return _.method="throw",_.arg=T.arg,_.delegate=null,c;var B=T.arg;return B?B.done?(_[y.resultName]=B.value,_.next=y.nextLoc,_.method!=="return"&&(_.method="next",_.arg=void 0),_.delegate=null,c):B:(_.method="throw",_.arg=new TypeError("iterator result is not an object"),_.delegate=null,c)}function P(y){var _={tryLoc:y[0]};1 in y&&(_.catchLoc=y[1]),2 in y&&(_.finallyLoc=y[2],_.afterLoc=y[3]),this.tryEntries.push(_)}function R(y){var _=y.completion||{};_.type="normal",delete _.arg,y.completion=_}function M(y){this.tryEntries=[{tryLoc:"root"}],y.forEach(P,this),this.reset(!0)}function F(y){if(y){var _=y[i];if(_)return _.call(y);if(typeof y.next=="function")return y;if(!isNaN(y.length)){var w=-1,L=function T(){for(;++w<y.length;)if(r.call(y,w))return T.value=y[w],T.done=!1,T;return T.value=void 0,T.done=!0,T};return L.next=L}}return{next:z}}function z(){return{value:void 0,done:!0}}return f.prototype=d,e(D,"constructor",{value:d,configurable:!0}),e(d,"constructor",{value:f,configurable:!0}),f.displayName=l(d,s,"GeneratorFunction"),u.isGeneratorFunction=function(y){var _=typeof y=="function"&&y.constructor;return!!_&&(_===f||(_.displayName||_.name)==="GeneratorFunction")},u.mark=function(y){return Object.setPrototypeOf?Object.setPrototypeOf(y,d):(y.__proto__=d,l(y,s,"GeneratorFunction")),y.prototype=Object.create(D),y},u.awrap=function(y){return{__await:y}},b(E.prototype),l(E.prototype,n,function(){return this}),u.AsyncIterator=E,u.async=function(y,_,w,L,T){T===void 0&&(T=Promise);var B=new E(o(y,_,w,L),T);return u.isGeneratorFunction(_)?B:B.next().then(function(V){return V.done?V.value:B.next()})},b(D),l(D,s,"Generator"),l(D,i,function(){return this}),l(D,"toString",function(){return"[object Generator]"}),u.keys=function(y){var _=Object(y),w=[];for(var L in _)w.push(L);return w.reverse(),function T(){for(;w.length;){var B=w.pop();if(B in _)return T.value=B,T.done=!1,T}return T.done=!0,T}},u.values=F,M.prototype={constructor:M,reset:function(y){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(R),!y)for(var _ in this)_.charAt(0)==="t"&&r.call(this,_)&&!isNaN(+_.slice(1))&&(this[_]=void 0)},stop:function(){this.done=!0;var y=this.tryEntries[0].completion;if(y.type==="throw")throw y.arg;return this.rval},dispatchException:function(y){if(this.done)throw y;var _=this;function w(q,C){return B.type="throw",B.arg=y,_.next=q,C&&(_.method="next",_.arg=void 0),!!C}for(var L=this.tryEntries.length-1;L>=0;--L){var T=this.tryEntries[L],B=T.completion;if(T.tryLoc==="root")return w("end");if(T.tryLoc<=this.prev){var V=r.call(T,"catchLoc"),K=r.call(T,"finallyLoc");if(V&&K){if(this.prev<T.catchLoc)return w(T.catchLoc,!0);if(this.prev<T.finallyLoc)return w(T.finallyLoc)}else if(V){if(this.prev<T.catchLoc)return w(T.catchLoc,!0)}else{if(!K)throw new Error("try statement without catch or finally");if(this.prev<T.finallyLoc)return w(T.finallyLoc)}}}},abrupt:function(y,_){for(var w=this.tryEntries.length-1;w>=0;--w){var L=this.tryEntries[w];if(L.tryLoc<=this.prev&&r.call(L,"finallyLoc")&&this.prev<L.finallyLoc){var T=L;break}}T&&(y==="break"||y==="continue")&&T.tryLoc<=_&&_<=T.finallyLoc&&(T=null);var B=T?T.completion:{};return B.type=y,B.arg=_,T?(this.method="next",this.next=T.finallyLoc,c):this.complete(B)},complete:function(y,_){if(y.type==="throw")throw y.arg;return y.type==="break"||y.type==="continue"?this.next=y.arg:y.type==="return"?(this.rval=this.arg=y.arg,this.method="return",this.next="end"):y.type==="normal"&&_&&(this.next=_),c},finish:function(y){for(var _=this.tryEntries.length-1;_>=0;--_){var w=this.tryEntries[_];if(w.finallyLoc===y)return this.complete(w.completion,w.afterLoc),R(w),c}},catch:function(y){for(var _=this.tryEntries.length-1;_>=0;--_){var w=this.tryEntries[_];if(w.tryLoc===y){var L=w.completion;if(L.type==="throw"){var T=L.arg;R(w)}return T}}throw new Error("illegal catch attempt")},delegateYield:function(y,_,w){return this.delegate={iterator:F(y),resultName:_,nextLoc:w},this.method==="next"&&(this.arg=void 0),c}},u}function ke(u){"@babel/helpers - typeof";return ke=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(a){return typeof a}:function(a){return a&&typeof Symbol=="function"&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},ke(u)}function vt(u,a,r,e,t,i,n){try{var s=u[i](n),l=s.value}catch(o){r(o);return}s.done?a(l):Promise.resolve(l).then(e,t)}function H(u){return function(){var a=this,r=arguments;return new Promise(function(e,t){var i=u.apply(a,r);function n(l){vt(i,e,t,n,s,"next",l)}function s(l){vt(i,e,t,n,s,"throw",l)}n(void 0)})}}function Q(u,a){if(!(u instanceof a))throw new TypeError("Cannot call a class as a function")}function mt(u,a){for(var r=0;r<a.length;r++){var e=a[r];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(u,At(e.key),e)}}function $(u,a,r){return a&&mt(u.prototype,a),r&&mt(u,r),Object.defineProperty(u,"prototype",{writable:!1}),u}function p(u,a,r){return a=At(a),a in u?Object.defineProperty(u,a,{value:r,enumerable:!0,configurable:!0,writable:!0}):u[a]=r,u}function Oe(u,a){if(typeof a!="function"&&a!==null)throw new TypeError("Super expression must either be null or a function");u.prototype=Object.create(a&&a.prototype,{constructor:{value:u,writable:!0,configurable:!0}}),Object.defineProperty(u,"prototype",{writable:!1}),a&&it(u,a)}function Re(u){return Re=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(r){return r.__proto__||Object.getPrototypeOf(r)},Re(u)}function it(u,a){return it=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},it(u,a)}function ir(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function nr(u,a){if(u==null)return{};var r={},e=Object.keys(u),t,i;for(i=0;i<e.length;i++)t=e[i],!(a.indexOf(t)>=0)&&(r[t]=u[t]);return r}function nt(u,a){if(u==null)return{};var r=nr(u,a),e,t;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(u);for(t=0;t<i.length;t++)e=i[t],!(a.indexOf(e)>=0)&&Object.prototype.propertyIsEnumerable.call(u,e)&&(r[e]=u[e])}return r}function N(u){if(u===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return u}function sr(u,a){if(a&&(typeof a=="object"||typeof a=="function"))return a;if(a!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return N(u)}function Me(u){var a=ir();return function(){var e=Re(u),t;if(a){var i=Re(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return sr(this,t)}}function ue(u,a){return or(u)||rr(u,a)||Lt(u,a)||cr()}function ar(u){return ur(u)||lr(u)||Lt(u)||hr()}function ur(u){if(Array.isArray(u))return st(u)}function or(u){if(Array.isArray(u))return u}function lr(u){if(typeof Symbol<"u"&&u[Symbol.iterator]!=null||u["@@iterator"]!=null)return Array.from(u)}function Lt(u,a){if(u){if(typeof u=="string")return st(u,a);var r=Object.prototype.toString.call(u).slice(8,-1);if(r==="Object"&&u.constructor&&(r=u.constructor.name),r==="Map"||r==="Set")return Array.from(u);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return st(u,a)}}function st(u,a){(a==null||a>u.length)&&(a=u.length);for(var r=0,e=new Array(a);r<a;r++)e[r]=u[r];return e}function hr(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function cr(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function fr(u,a){if(typeof u!="object"||u===null)return u;var r=u[Symbol.toPrimitive];if(r!==void 0){var e=r.call(u,a||"default");if(typeof e!="object")return e;throw new TypeError("@@toPrimitive must return a primitive value.")}return(a==="string"?String:Number)(u)}function At(u){var a=fr(u,"string");return typeof a=="symbol"?a:String(a)}var dr=9e4/2,pt=3,we=9e4,Xe=5*9e4,We=9e4,vr=9e4/2,mr=9e4*5,pr=function(){function u(a,r,e,t){ve(this,u),this.videoTrack=a,this.audioTrack=r,this.metadataTrack=e,this._baseDts=-1,this._baseVideoDts=-1,this._baseAudioDts=-1,this._baseDtsInited=!1,this._audioNextPts=void 0,this._videoNextDts=void 0,this._audioTimestampBreak=!1,this._videoTimestampBreak=!1,this._lastAudioExceptionGapDot=0,this._lastAudioExceptionOverlapDot=0,this._lastAudioExceptionLargeGapDot=0,this._needForceFixLargeGap=t==null?void 0:t.forceFixLargeGap,this._largeGapThreshold=(t==null?void 0:t.largeGapThreshold)||mr}return de(u,[{key:"fix",value:function(){var r=this,e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;e=Math.round(e*9e4);var n=this.videoTrack,s=this.audioTrack,l=n.samples,o=s.samples;if(!(!l.length&&!o.length)){var h=l[0],c=o[0],v=0;if(l.length&&o.length&&(v=h.dts-c.pts),this._baseDtsInited||this._calculateBaseDts(this.audioTrack,this.videoTrack),t&&(this._calculateBaseDts(this.audioTrack,this.videoTrack),this._baseDts-=e,this._baseAudioDts-=e,this._baseVideoDts-=e),!i){this._videoNextDts=v>0?e+v:e,this._audioNextPts=v>0?e:e-v,this._needForceFixLargeGap&&(this._videoNextDts=0,this._audioNextPts=0);var f=h?h.dts-this._baseDts-this._videoNextDts:0,d=c?c.pts-this._baseDts-this._audioNextPts:0;Math.abs(f||d)>We&&(this._calculateBaseDts(this.audioTrack,this.videoTrack),this._baseDts-=e)}if(this._resetBaseDtsWhenStreamBreaked(),this._fixAudio(s),this._fixVideo(n),this.metadataTrack.exist()){var S=this.metadataTrack.timescale;this.metadataTrack.seiSamples.forEach(function(m){m.pts=m.originPts-r._baseDts,m.time=Math.max(0,m.pts)/S})}n.samples.length&&(n.baseMediaDecodeTime=n.samples[0].dts),s.samples.length&&(s.baseMediaDecodeTime=s.samples[0].pts*s.timescale/9e4)}}},{key:"_fixVideo",value:function(r){var e=this,t=r.samples;if(t.length){if(t.forEach(function(P){P.dts-=e._needForceFixLargeGap?e._baseVideoDts:e._baseDts,P.pts-=e._needForceFixLargeGap?e._baseVideoDts:e._baseDts}),this._videoNextDts===void 0){var i=t[0];this._videoNextDts=i.dts}var n=t.length,s=0,l=t[0],o=t[1],h=this._videoNextDts-l.dts;if(Math.abs(h)>vr){var c;if(r.warnings.push({type:re.LARGE_VIDEO_GAP_BETWEEN_CHUNK,nextDts:this._videoNextDts/90,firstSampleDts:l.dts/90,nextSampleDts:(((c=t[1])===null||c===void 0?void 0:c.dts)||0)/90,sampleDuration:h/90}),l.dts+=h,l.pts+=h,o&&Math.abs(o.dts-l.dts)>We)this._videoTimestampBreak=!0,t.forEach(function(P,R){R!==0&&(P.dts+=h,P.pts+=h)});else for(var v=1;v<n-1;v++){var f,d=(f=t[v])===null||f===void 0?void 0:f.dts,S=t[v-1].dts;d&&d-S<0&&(t[v].dts+=h,t[v].pts+=h)}}var m;if(r.fpsNum&&r.fpsDen&&(m=r.timescale*(r.fpsDen/r.fpsNum)),m<90*10&&(m=0),!m){var g=r.samples[0],D=r.samples[1];m=n===1?9e3:Math.floor(D.dts-g.dts)}for(var b=0;b<n;b++){var E=t[b].dts,k=t[b+1];if(b<n-1?s=k.dts-E:t[b-1]?s=Math.min(E-t[b-1].dts,m):s=m,s>We||s<0){this._videoTimestampBreak=!0,s=this._audioTimestampBreak?m:Math.max(s,30*90);var O=this._audioNextPts||0;k&&k.dts>O&&(s=m),r.warnings.push({type:re.LARGE_VIDEO_GAP,time:E/r.timescale,dts:E,originDts:t[b].originDts,nextDts:this._videoNextDts,sampleDuration:s,refSampleDuration:m})}t[b].duration=s,this._videoNextDts+=s}}}},{key:"_fixAudio",value:function(r){var e=this,t=r.samples;if(t.length){if(r.codecType===pe.MP3){this.lastAudioSample&&t.unshift(this.lastAudioSample);for(var i=0;i<t.length;i++){var n=t[i];if(t[i+1])n.duration=t[i+1].pts-n.pts;else break;n.pts-=this._baseDts,n.dts=n.pts}this.lastAudioSample=t.pop();return}t.forEach(function(s){s.pts-=e._needForceFixLargeGap?e._baseAudioDts:e._baseDts,s.dts=s.pts}),this._doFixAudioInternal(r,t,9e4)}}},{key:"_calculateBaseDts",value:function(r,e){var t=r.samples,i=e.samples;if(!t.length&&!i.length)return!1;var n=1/0,s=1/0;t.length&&(r.baseDts=n=t[0].pts,this._baseAudioDts=n),i.length&&(e.baseDts=s=i[0].dts,this._baseVideoDts=s),this._baseDts=Math.min(n,s);var l=s-n,o=!1;return Number.isFinite(l)&&Math.abs(l)>dr&&e.warnings.push({type:re.LARGE_AV_SHIFT,videoBaseDts:s,audioBasePts:n,baseDts:this._baseDts,delta:l}),Number.isFinite(l)&&Math.abs(l)>this._largeGapThreshold*we&&(o=!0),this._baseDtsInited||(o&&this._needForceFixLargeGap?this._needForceFixLargeGap=!0:this._needForceFixLargeGap=!1),this._baseDtsInited=!0,!0}},{key:"_resetBaseDtsWhenStreamBreaked",value:function(){if(this._baseDtsInited&&this._videoTimestampBreak&&this._audioTimestampBreak){var r=this._calculateBaseDts(this.audioTrack,this.videoTrack);if(!r)return;this._baseDts-=Math.min(this._audioNextPts,this._videoNextDts),this._audioLastSample=null,this._videoLastSample=null,this._videoTimestampBreak=!1,this._audioTimestampBreak=!1}}},{key:"_doFixAudioInternal",value:function(r,e,t){r.sampleDuration||(r.sampleDuration=oe.getFrameDuration(r.timescale,t));var i=r.sampleDuration;if(this._audioNextPts===void 0){var n=e[0];this._audioNextPts=n.pts}for(var s=0;s<e.length;s++){var l=this._audioNextPts,o=e[s],h=o.pts-l;if(!this._audioTimestampBreak&&h>=pt*i&&h<=we&&!Gt){var c=oe.getSilentFrame(r.codec,r.channelCount)||e[0].data.subarray(),v=Math.floor(h/i);Math.abs(o.pts-this._lastAudioExceptionGapDot)>Xe&&(this._lastAudioExceptionGapDot=o.pts),r.warnings.push({type:re.AUDIO_FILLED,pts:o.pts/90,originPts:o.originPts,count:v,nextPts:l/90,refSampleDuration:i});for(var f=0;f<v;f++){var d=new be(Math.floor(l),c);d.originPts=Math.floor(this._baseDts+l),e.splice(s,0,d),this._audioNextPts+=i,s++}s--}else h<=-pt*i&&h>=-1*we?(Math.abs(o.pts-this._lastAudioExceptionOverlapDot)>Xe&&(this._lastAudioExceptionOverlapDot=o.pts,r.warnings.push({type:re.AUDIO_DROPPED,pts:o.pts/90,originPts:o.originPts,nextPts:l/90,refSampleDuration:i})),e.splice(s,1),s--):(Math.abs(h)>=we&&(this._audioTimestampBreak=!0,Math.abs(o.pts-this._lastAudioExceptionLargeGapDot)>Xe&&(this._lastAudioExceptionLargeGapDot=o.pts,r.warnings.push({type:re.LARGE_AUDIO_GAP,time:o.pts/1e3,pts:o.pts/90,originPts:o.originPts,nextPts:l/90,sampleDuration:h,refSampleDuration:i}))),o.dts=o.pts=l,this._audioNextPts+=i)}}}]),u}(),gr=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],yr=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],Sr=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],_r=[0,1,1,4],De=null,gt=function(){function u(){ve(this,u)}return de(u,null,[{key:"isHeader",value:function(r,e){return e+1<r.length&&r[e]===255&&(r[e+1]&224)===224&&(r[e+1]&6)!==0}},{key:"appendFrame",value:function(r,e,t,i,n){if(!(t+24>e.length)){var s=u.parseHeader(e,t);if(s&&t+s.frameLength<=e.length){var l=s.samplesPerFrame*9e4/s.sampleRate,o=i+n*l,h={data:e.subarray(t,t+s.frameLength),pts:o,dts:o};return h.size=h.data.byteLength,r.config=[],r.channelCount=s.channelCount,r.sampleRate=s.sampleRate,Ht?r.codec="mp3":r.container="audio/mpeg",r.samples.push(h),{length:s.frameLength}}}}},{key:"parseHeader",value:function(r,e){var t=r[e+1]>>3&3,i=r[e+1]>>1&3,n=r[e+2]>>4&15,s=r[e+2]>>2&3;if(t!==1&&n!==0&&n!==15&&s!==3){var l=r[e+2]>>1&1,o=r[e+3]>>6,h=t===3?3-i:i===3?3:4,c=gr[h*14+n-1]*1e3,v=t===3?0:t===2?1:2,f=yr[v*3+s],d=o===3?1:2,S=Sr[t][i],m=_r[i],g=S*8*m,D=Math.floor(S*c/f+l)*m;if(De===null){var b=navigator.userAgent||"",E=b.match(/Chrome\/(\d+)/i);De=E?parseInt(E[1]):0}var k=!!De&&De<=87;return k&&i===2&&c>=224e3&&o===0&&(r[e+3]=r[e+3]|128),{sampleRate:f,channelCount:d,frameLength:D,samplesPerFrame:g}}}}]),u}(),te=new tt("TsDemuxer"),It=function(){function u(a,r,e){var t=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};ve(this,u),ae(this,"_pmtId",-1),ae(this,"_remainingPacketData",null),ae(this,"_videoPesData",[]),ae(this,"_audioPesData",[]),ae(this,"_gopId",0),this.videoTrack=a||new wt,this.audioTrack=r||new Dt,this.metadataTrack=e||new Tt,this._fixer=new pr(this.videoTrack,this.audioTrack,this.metadataTrack,t)}return de(u,[{key:"demux",value:function(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,i=this.audioTrack,n=this.videoTrack,s=this.metadataTrack;e&&(this._pmtId=-1,n.reset(),i.reset(),s.reset()),!t||e?(this._remainingPacketData=null,this._videoPesData=[],this._audioPesData=[]):(n.samples=[],i.samples=[],s.seiSamples=[],n.warnings=[],i.warnings=[],this._remainingPacketData&&(r=Ie(this._remainingPacketData,r),this._remainingPacketData=null));var l=r.length,o=l%188;o&&(this._remainingPacketData=r.subarray(l-o),l-=o);for(var h=n.pid,c=i.pid,v=0;v<l;v+=188){if(r[v]!==71)throw new Error("TS packet did not start with 0x47");var f=!!(r[v+1]&64),d=((r[v+1]&31)<<8)+r[v+2],S=(r[v+3]&48)>>4,m=void 0;if(S>1){if(m=v+5+r[v+4],m===v+188)continue}else m=v+4;switch(d){case 0:f&&(m+=r[m]+1),this._pmtId=(r[m+10]&31)<<8|r[m+11];break;case this._pmtId:{f&&(m+=r[m]+1);var g=m+3+((r[m+1]&15)<<8|r[m+2])-4,D=(r[m+10]&15)<<8|r[m+11];for(m+=12+D;m<g;){var b=(r[m+1]&31)<<8|r[m+2];switch(r[m]){case 15:i.pid=c=b;break;case 3:case 4:i.pid===-1&&(i.pid=c=b,i.codecType=pe.MP3);break;case 27:if(h!==-1)break;n.codecType=Ee.AVC,n.pid=h=b;break;case 36:if(h!==-1)break;n.codecType=Ee.HEVC,n.pid=h=b;break;default:te.warn("Unsupported stream. type: ".concat(r[m],", pid: ").concat(b))}m+=((r[m+3]&15)<<8|r[m+4])+5}}break;case h:f&&this._videoPesData.length&&this._parseVideoData(),this._videoPesData.push(r.subarray(m,v+188));break;case c:f&&this._audioPesData.length&&this._parseAudioData(),this._audioPesData.push(r.subarray(m,v+188));break;case 17:case 8191:break;default:te.warn("Unknown pid: ".concat(d))}}return this._parseVideoData(),this._parseAudioData(),i.formatTimescale=n.formatTimescale=n.timescale=s.timescale=9e4,i.timescale=i.sampleRate||0,{videoTrack:n,audioTrack:i,metadataTrack:s}}},{key:"fix",value:function(r,e,t){return this._fixer.fix(r,e,t),{videoTrack:this.videoTrack,audioTrack:this.audioTrack,metadataTrack:this.metadataTrack}}},{key:"demuxAndFix",value:function(r,e,t,i){return this.demux(r,e,t),this.fix(i,e,t)}},{key:"_parseVideoData",value:function(){if(this._videoPesData.length){var r=u._parsePES(Ie.apply(void 0,Pe(this._videoPesData)));if(!r){te.warn("Cannot parse video pes",this._videoPesData);return}var e=_e.parseAnnexB(r.data);e?this._createVideoSample(e,r.pts,r.dts):te.warn("Cannot parse avc units",r),this._videoPesData=[]}}},{key:"_createVideoSample",value:function(r,e,t){var i=this;if(r.length){var n=this.videoTrack,s=n.codecType===Ee.HEVC,l=new rt(e,t);r.forEach(function(o){var h=s?o[0]>>>1&63:o[0]&31;switch(h){case 5:case 16:case 17:case 18:case 19:case 20:case 21:case 22:case 23:if(!s&&h!==5||s&&h===5)break;l.setToKeyframe(),i._gopId++;break;case 6:case 39:case 40:if(!s&&h!==6||s&&h===6)break;i.metadataTrack.seiSamples.push(new Yt(_e.parseSEI(_e.removeEPB(o),s),e));return;case 32:if(!s)break;if(!n.vps.length){var c=ct.parseVPS(_e.removeEPB(o),n.hvcC);n.hvcC=n.hvcC||c,n.vps=[o]}break;case 7:case 33:if(!s&&h!==7||s&&h===7)break;if(!n.sps.length){var v=_e.removeEPB(o),f=s?ct.parseSPS(v,n.hvcC):zt.parseSPS(v);n.sps=[o],n.hvcC=n.hvcC||f.hvcC,n.codec=f.codec,n.width=f.width,n.height=f.height,n.sarRatio=f.sarRatio,n.fpsNum=f.fpsNum,n.fpsDen=f.fpsDen}break;case 8:case 34:if(!s&&h!==8||s&&h===8)break;n.pps.length||(n.pps=[o]);break;case 9:case 35:break;case 38:if(s){for(var d=!1,S=2;S<o.byteLength;S++)if(o[S]===255){d=!0;break}if(!d)return}break}l.units.push(o)}),l.gopId=this._gopId,this._pushVideoSample(n,l)}}},{key:"_pushVideoSample",value:function(r,e){if(e.units.length)if(e.pts===null||e.pts===void 0){te.warn("Video sample no pts",e);var t=r.samples[r.samples.length-1];t?(e.pts=t.pts,e.dts=t.dts):te.warn("Drop video sample",e)}else r.samples.push(e)}},{key:"_parseAudioData",value:function(){if(this._audioPesData.length){var r=u._parsePES(Ie.apply(void 0,Pe(this._audioPesData)));if(!r){te.warn("Cannot parse audio pes",this._audioPesData);return}switch(this.audioTrack.codecType){case pe.AAC:this._parseAacData(r);break;case pe.MP3:this._parseMPEG(r);break}this._audioPesData=[]}}},{key:"_parseAacData",value:function(r){var e=this.audioTrack,t=r.pts;if(t==null){if(te.warn("AAC pes not pts",e),!e.samples.length||!e.sampleRate)return;t=e.samples[e.samples.length-1].pts+oe.getFrameDuration(e.sampleRate)}var i=oe.parseADTS(r.data,t);if(i){var n;e.codec=i.codec,e.channelCount=i.channelCount,e.sampleRate=i.sampleRate,e.objectType=i.objectType,e.sampleRateIndex=i.samplingFrequencyIndex,e.config=i.config,(n=e.samples).push.apply(n,Pe(i.frames.map(function(s){return new be(s.pts,s.data)}))),i.skip&&te.warn("Skip aac adts ".concat(i.skip," bits")),i.remaining&&te.warn("Remaining aac adts ".concat(i.remaining," bits"))}else te.warn("Cannot parse aac adts",r)}},{key:"_parseMPEG",value:function(r){var e=r.data,t=e.length,i=0,n=0,s=r.pts;if(s===void 0){te.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;n<t;)if(gt.isHeader(e,n)){var l=gt.appendFrame(this.audioTrack,e,n,s,i);if(l)n+=l.length,i++;else break}else n++}}],[{key:"probe",value:function(r){return r.length?r[0]===71&&r[188]===71&&r[376]===71:!1}},{key:"_parsePES",value:function(r){var e=r[8];if(!(e==null||r.length<e+9)){var t=r[0]<<16|r[1]<<8|r[2];if(t===1){var i=(r[4]<<8)+r[5];if(!(i&&i>r.length-6)){var n,s,l=r[7];return l&192&&(n=(r[9]&14)*536870912+(r[10]&255)*4194304+(r[11]&254)*16384+(r[12]&255)*128+(r[13]&254)/2,l&64?(s=(r[14]&14)*536870912+(r[15]&255)*4194304+(r[16]&254)*16384+(r[17]&255)*128+(r[18]&254)/2,n-s>60*9e4&&(n=s)):s=n),{data:r.subarray(9+e),pts:n,dts:s}}}}}}]),u}(),qe=function(){function u(a,r,e){ve(this,u),this.dv=new DataView(a),this.start=this.offset=r||this.dv.byteOffset,this.end=e?this.start+e:this.start+this.dv.byteLength}return de(u,[{key:"buffer",get:function(){return this.dv.buffer}},{key:"unreadLength",get:function(){return Math.max(this.end-this.offset,0)}},{key:"size",get:function(){return this.end-this.start}},{key:"readFloat",value:function(r){var e=0;switch(r){case 4:e=this.dv.getFloat32(this.offset);break;case 8:e=this.dv.getFloat64(this.offset);break;default:throw new Error("read ".concat(r,"-byte float is not supported"))}return this.offset+=r,e}},{key:"back",value:function(r){this.offset-=r}},{key:"skip",value:function(r){this.offset+=r}},{key:"readInt",value:function(r){var e=this.offset;switch(this.offset+=r,r){case 1:return this.dv.getInt8(e);case 2:return this.dv.getInt16(e);case 4:return this.dv.getInt32(e);default:throw new Error("read ".concat(r,"-byte integers is not supported"))}}},{key:"read",value:function(r){var e=this.offset;switch(this.offset+=r,r){case 1:return this.dv.getUint8(e);case 2:return this.dv.getUint16(e);case 3:return(this.dv.getUint16(e)<<8)+this.dv.getUint8(e+2);case 4:return this.dv.getUint32(e);default:return this.back(r-4),this.read(r-4)+this.dv.getUint32(e)*Math.pow(256,r-4)}}},{key:"write",value:function(r,e){var t=this.offset;switch(this.offset+=r,r){case 1:return this.dv.setUint8(t,e);case 2:return this.dv.setUint16(t,e);case 3:return this.dv.setUint8(t,e>>>16),this.dv.setUint16(t+1,65535&e);case 4:return this.dv.setUint32(t,e);default:throw new Error("write ".concat(r,"-byte integers is not supported"))}}},{key:"readToBuffer",value:function(r){var e;return this.offset||r?e=this.dv.buffer.slice(this.offset,r?this.offset+r:this.end):e=this.dv.buffer,this.offset+=e.byteLength,e}},{key:"readToUint8",value:function(r){var e=new Uint8Array(this.dv.buffer,this.offset,r||this.unreadLength);return this.offset+=e.byteLength,e}},{key:"readString",value:function(r){for(var e=0,t="";e<r;e++)t+=String.fromCharCode(this.dv.getUint8(this.offset)),this.offset++;return t}}],[{key:"fromUint8",value:function(r){return new u(r.buffer,r.byteOffset,r.byteLength)}},{key:"concatUint8s",value:function(r){var e=new Uint8Array(r.reduce(function(i,n){return i+n.byteLength},0)),t=0;return r.forEach(function(i){e.set(i,t),t+=i.byteLength}),e}},{key:"concatUint8",value:function(){for(var r=arguments.length,e=new Array(r),t=0;t<r;t++)e[t]=arguments[t];return this.concatUint8s(e)}}]),u}(),br=function(){function u(a,r){ve(this,u),this.offset=0,this.val=a,this.size=r}return de(u,[{key:"skip",value:function(r){this.offset+=r}},{key:"read",value:function(r){var e=this.size-this.offset-r;if(e>=0){var t=0,i=0;if(this.offset+=r,this.size>31){for(;i<r;i++)t+=Math.pow(2,i);return this.val/Math.pow(2,e)&t}else{for(;i<r;i++)t+=1<<i;return this.val>>>e&t}}throw new Error("the number of the read operation exceeds the total length limit of bits")}}],[{key:"fromByte",value:function(r,e){return new u(r.read(e),e<<3)}}]),u}(),X=function(){function u(){ve(this,u)}return de(u,null,[{key:"findBox",value:function(r,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,i=[];if(!r)return i;for(var n=0,s="",l=0;r.length>7;){if(n=I(r),s=String.fromCharCode.apply(null,r.subarray(4,8)),l=8,n===1?(n=ce(r,8),l+=8):n||(n=r.length),!e[0]||s===e[0]){var o=r.subarray(0,n);if(e.length<2)i.push({start:t,size:n,headerSize:l,type:s,data:o});else return u.findBox(o.subarray(l),e.slice(1),t+l)}t+=n,r=r.subarray(n)}return i}},{key:"tfhd",value:function(r){return U(r,!0,function(e,t){e.trackId=I(t);var i=4,n=e.flags&255&1,s=e.flags&255&2,l=e.flags&255&8,o=e.flags&255&16,h=e.flags&255&32;n&&(i+=4,e.baseDataOffset=I(t,i),i+=4),s&&(e.sampleDescriptionIndex=I(t,i),i+=4),l&&(e.defaultSampleDuration=I(t,i),i+=4),o&&(e.defaultSampleSize=I(t,i),i+=4),h&&(e.defaultSampleFlags=I(t,i))})}},{key:"sidx",value:function(r){return U(r,!0,function(e,t){var i=0;e.reference_ID=I(t,i),i+=4,e.timescale=I(t,i),i+=4,e.version===0?(e.earliest_presentation_time=I(t,i),i+=4,e.first_offset=I(t,i),i+=4):(e.earliest_presentation_time=ce(t,i),i+=8,e.first_offset=ce(t,i),i+=8),i+=2,e.references=[];var n=W(t,i);i+=2;for(var s=0;s<n;s++){var l={};e.references.push(l);var o=I(t,i);i+=4,l.reference_type=o>>31&1,l.referenced_size=o&2147483647,l.subsegment_duration=I(t,i),i+=4,o=I(t,i),i+=4,l.starts_with_SAP=o>>31&1,l.SAP_type=o>>28&7,l.SAP_delta_time=o&268435455}})}},{key:"moov",value:function(r){return U(r,!1,function(e,t,i){e.mvhd=u.mvhd(u.findBox(t,["mvhd"],i)[0]),e.trak=u.findBox(t,["trak"],i).map(function(n){return u.trak(n)}),e.pssh=u.pssh(u.findBox(t,["pssh"],i)[0])})}},{key:"mvhd",value:function(r){return U(r,!0,function(e,t){var i=0;e.version===1?(e.timescale=I(t,16),e.duration=ce(t,20),i+=28):(e.timescale=I(t,8),e.duration=I(t,12),i+=16),e.nextTrackId=I(t,i+76)})}},{key:"trak",value:function(r){return U(r,!1,function(e,t,i){e.tkhd=u.tkhd(u.findBox(t,["tkhd"],i)[0]),e.mdia=u.mdia(u.findBox(t,["mdia"],i)[0])})}},{key:"tkhd",value:function(r){return U(r,!0,function(e,t){var i=qe.fromUint8(t);e.version===1?(i.read(8),i.read(8),e.trackId=i.read(4),i.read(4),e.duration=i.read(8)):(i.read(4),i.read(4),e.trackId=i.read(4),i.read(4),e.duration=i.read(4)),i.skip(16),e.matrix=[];for(var n=0;n<36;n++)e.matrix.push(i.read(1));i.back(36);for(var s=[],l=0,o;l<3;l++)s.push(Ke(i.readInt(2),i.readInt(2))),s.push(Ke(i.readInt(2),i.readInt(2))),o=i.readInt(4),s.push(Ke(o>>30,o&1073741823));e.rotation=Kt(s),e.width=i.read(4),e.height=i.read(4)})}},{key:"mdia",value:function(r){return U(r,!1,function(e,t,i){e.mdhd=u.mdhd(u.findBox(t,["mdhd"],i)[0]),e.hdlr=u.hdlr(u.findBox(t,["hdlr"],i)[0]),e.minf=u.minf(u.findBox(t,["minf"],i)[0])})}},{key:"mdhd",value:function(r){return U(r,!0,function(e,t){var i=0;e.version===1?(e.timescale=I(t,16),e.duration=ce(t,20),i+=28):(e.timescale=I(t,8),e.duration=I(t,12),i+=16);var n=W(t,i);e.language=String.fromCharCode((n>>10&31)+96,(n>>5&31)+96,(n&31)+96)})}},{key:"hdlr",value:function(r){return U(r,!0,function(e,t){e.version===0&&(e.handlerType=String.fromCharCode.apply(null,t.subarray(4,8)))})}},{key:"minf",value:function(r){return U(r,!1,function(e,t,i){e.vmhd=u.vmhd(u.findBox(t,["vmhd"],i)[0]),e.smhd=u.smhd(u.findBox(t,["smhd"],i)[0]),e.stbl=u.stbl(u.findBox(t,["stbl"],i)[0])})}},{key:"vmhd",value:function(r){return U(r,!0,function(e,t){e.graphicsmode=W(t),e.opcolor=[W(t,2),W(t,4),W(t,6)]})}},{key:"smhd",value:function(r){return U(r,!0,function(e,t){e.balance=W(t)})}},{key:"stbl",value:function(r){return U(r,!1,function(e,t,i){var n,s,l;e.stsd=u.stsd(u.findBox(t,["stsd"],i)[0]),e.stts=u.stts(u.findBox(t,["stts"],i)[0]),e.ctts=u.ctts(u.findBox(t,["ctts"],i)[0]),e.stsc=u.stsc(u.findBox(t,["stsc"],i)[0]),e.stsz=u.stsz(u.findBox(t,["stsz"],i)[0]),e.stco=u.stco(u.findBox(t,["stco"],i)[0]),e.stco||(e.co64=u.co64(u.findBox(t,["co64"],i)[0]),e.stco=e.co64);var o=(n=e.stsd.entries[0])===null||n===void 0||(s=n.sinf)===null||s===void 0||(l=s.schi)===null||l===void 0?void 0:l.tenc.default_IV_size;e.stss=u.stss(u.findBox(t,["stss"],i)[0]),e.senc=u.senc(u.findBox(t,["senc"],i)[0],o)})}},{key:"senc",value:function(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8;return U(r,!0,function(t,i){var n=0,s=I(i,n);n+=4,t.samples=[];for(var l=0;l<s;l++){var o={};o.InitializationVector=[];for(var h=0;h<e;h++)o.InitializationVector[h]=i[n+h];if(n+=e,t.flags&2){o.subsamples=[];var c=W(i,n);n+=2;for(var v=0;v<c;v++){var f={};f.BytesOfClearData=W(i,n),n+=2,f.BytesOfProtectedData=I(i,n),n+=4,o.subsamples.push(f)}}t.samples.push(o)}})}},{key:"pssh",value:function(r){return U(r,!0,function(e,t){for(var i=[],n=[],s=0,l=0;l<16;l++)n.push($e(t[s+l]));if(s+=16,e.version>0){var o=I(t,s);s+=4;for(var h=0;h<(""+o).length;h++)for(var c=0;c<16;c++){var v=t[s];s+=1,i.push($e(v))}}var f=I(t,s);e.data_size=f,s+=4,e.kid=i,e.system_id=n,e.buffer=t})}},{key:"stsd",value:function(r){return U(r,!0,function(e,t,i){e.entryCount=I(t),e.entries=u.findBox(t.subarray(4),[],i+4).map(function(n){switch(n.type){case"av01":return u.av01(n);case"avc1":case"avc2":case"avc3":case"avc4":return u.avc1(n);case"hvc1":case"hev1":return u.hvc1(n);case"mp4a":return u.mp4a(n);case"alaw":case"ulaw":return u.alaw(n);case"enca":return U(n,!1,function(s,l,o){s.channelCount=W(l,16),s.samplesize=W(l,18),s.sampleRate=I(l,24)/65536,l=l.subarray(28),s.sinf=u.sinf(u.findBox(l,["sinf"],o)[0]),s.esds=u.esds(u.findBox(l,["esds"],o)[0])});case"encv":return U(n,!1,function(s,l,o){s.width=W(l,24),s.height=W(l,26),s.horizresolution=I(l,28),s.vertresolution=I(l,32),l=l.subarray(78),s.sinf=u.sinf(u.findBox(l,["sinf"],o)[0]),s.avcC=u.avcC(u.findBox(l,["avcC"],o)[0]),s.hvcC=u.hvcC(u.findBox(l,["hvcC"],o)[0]),s.pasp=u.pasp(u.findBox(l,["pasp"],o)[0])})}}).filter(Boolean)})}},{key:"tenc",value:function(r){return U(r,!1,function(e,t){var i=6;e.default_IsEncrypted=t[i],i+=1,e.default_IV_size=t[i],i+=1,e.default_KID=[];for(var n=0;n<16;n++)e.default_KID.push($e(t[i])),i+=1})}},{key:"schi",value:function(r){return U(r,!1,function(e,t,i){e.tenc=u.tenc(u.findBox(t,["tenc"],i)[0])})}},{key:"sinf",value:function(r){return U(r,!1,function(e,t,i){e.schi=u.schi(u.findBox(t,["schi"],i)[0]),e.frma=u.frma(u.findBox(t,["frma"],i)[0])})}},{key:"frma",value:function(r){return U(r,!1,function(e,t){e.data_format="";for(var i=0;i<4;i++)e.data_format+=String.fromCharCode(t[i])})}},{key:"colr",value:function(r){return U(r,!1,function(e,t){var i=qe.fromUint8(t);e.data=r.data,e.colorType=i.readString(4),e.colorType==="nclx"?(e.colorPrimaries=i.read(2),e.transferCharacteristics=i.read(2),e.matrixCoefficients=i.read(2),e.fullRangeFlag=i.read(1)>>7):(e.colorType==="rICC"||e.colorType==="prof")&&(e.iccProfile=t.readToUint8())})}},{key:"av01",value:function(r){return U(r,!1,function(e,t,i){var n=Qe(e,t),s=t.subarray(n);i+=n,e.av1C=u.av1C(u.findBox(s,["av1C"],i)[0]),e.colr=u.colr(u.findBox(s,["colr"],i)[0])})}},{key:"av1C",value:function(r){return U(r,!1,function(e,t){e.data=r.data;var i=qe.fromUint8(t),n=br.fromByte(i,4);e.marker=n.read(1),e.version=n.read(7),e.seqProfile=n.read(3),e.seqLevelIdx0=n.read(5),e.seqTier0=n.read(1),e.highBitdepth=n.read(1),e.twelveBit=n.read(1),e.monochrome=n.read(1),e.chromaSubsamplingX=n.read(1),e.chromaSubsamplingY=n.read(1),e.chromaSamplePosition=n.read(2),e.reserved=n.read(3),e.initialPresentationDelayPresent=n.read(1),e.initialPresentationDelayPresent?e.initialPresentationDelayMinusOne=n.read(4):e.initialPresentationDelayMinusOne=0,e.configOBUs=i.readToUint8();var s;e.seqLevelIdx0===2&&e.highBitdepth===1?s=e.twelveBit===1?"12":"10":e.seqProfile<=2&&(s=e.highBitdepth===1?"10":"08"),e.codec=["av01",e.seqProfile,(e.seqLevelIdx0<10?"0"+e.seqLevelIdx0:e.seqLevelIdx0)+(e.seqTier0?"H":"M"),s].join(".")})}},{key:"avc1",value:function(r){return U(r,!1,function(e,t,i){var n=Qe(e,t),s=t.subarray(n);i+=n,e.avcC=u.avcC(u.findBox(s,["avcC"],i)[0]),e.pasp=u.pasp(u.findBox(s,["pasp"],i)[0])})}},{key:"avcC",value:function(r){return U(r,!1,function(e,t){e.data=r.data,e.configurationVersion=t[0],e.AVCProfileIndication=t[1],e.profileCompatibility=t[2],e.AVCLevelIndication=t[3],e.codec=Xt([t[1],t[2],t[3]]),e.lengthSizeMinusOne=t[4]&3,e.spsLength=t[5]&31,e.sps=[];for(var i=6,n=0;n<e.spsLength;n++){var s=W(t,i);i+=2,e.sps.push(t.subarray(i,i+s)),i+=s}e.ppsLength=t[i],i+=1,e.pps=[];for(var l=0;l<e.ppsLength;l++){var o=W(t,i);i+=2,e.pps.push(t.subarray(i,i+=o)),i+=o}})}},{key:"hvc1",value:function(r){return U(r,!1,function(e,t,i){var n=Qe(e,t),s=t.subarray(n);i+=n,e.hvcC=u.hvcC(u.findBox(s,["hvcC"],i)[0]),e.pasp=u.pasp(u.findBox(s,["pasp"],i)[0])})}},{key:"hvcC",value:function(r){return U(r,!1,function(e,t){e.data=r.data,e.codec="hev1.1.6.L93.B0",e.configurationVersion=t[0];var i=t[1];e.generalProfileSpace=i>>6,e.generalTierFlag=(i&32)>>5,e.generalProfileIdc=i&31,e.generalProfileCompatibility=I(t,2),e.generalConstraintIndicatorFlags=t.subarray(6,12),e.generalLevelIdc=t[12],e.avgFrameRate=W(t,19),e.numOfArrays=t[22],e.vps=[],e.sps=[],e.pps=[];for(var n=23,s=0,l=0,o=0,h=0;h<e.numOfArrays;h++){s=t[n]&63,l=W(t,n+1),n+=3;for(var c=[],v=0;v<l;v++)o=W(t,n),n+=2,c.push(t.subarray(n,n+o)),n+=o;if(s===32){var f;(f=e.vps).push.apply(f,c)}else if(s===33){var d;(d=e.sps).push.apply(d,c)}else if(s===34){var S;(S=e.pps).push.apply(S,c)}}})}},{key:"pasp",value:function(r){return U(r,!1,function(e,t){e.hSpacing=I(t),e.vSpacing=I(t,4)})}},{key:"mp4a",value:function(r){return U(r,!1,function(e,t,i){var n=St(e,t);e.esds=u.esds(u.findBox(t.subarray(n),["esds"],i+n)[0])})}},{key:"esds",value:function(r){return U(r,!0,function(e,t){e.codec="mp4a.";for(var i=0,n=0,s=0,l=0;t.length;){for(i=0,l=t[i],n=t[i+1],i+=2;n&128;)s=(n&127)<<7,n=t[i],i+=1;if(s+=n&127,l===3)t=t.subarray(i+3);else if(l===4)e.codec+=(t[i].toString(16)+".").padStart(3,"0"),t=t.subarray(i+13);else if(l===5){var o=e.config=t.subarray(i,i+s),h=(o[0]&248)>>3;h===31&&o.length>=2&&(h=32+((o[0]&7)<<3)+((o[1]&224)>>5)),e.objectType=h,e.codec+=h.toString(16),e.codec[e.codec.length-1]==="."&&(e.codec=e.codec.substring(0,e.codec.length-1));return}else{e.codec[e.codec.length-1]==="."&&(e.codec=e.codec.substring(0,e.codec.length-1));return}}})}},{key:"alaw",value:function(r){return U(r,!1,function(e,t){St(e,t)})}},{key:"stts",value:function(r){return U(r,!0,function(e,t){for(var i=I(t),n=[],s=4,l=0;l<i;l++)n.push({count:I(t,s),delta:I(t,s+4)}),s+=8;e.entryCount=i,e.entries=n})}},{key:"ctts",value:function(r){return U(r,!0,function(e,t){var i=I(t),n=[],s=4;if(e.version===1)for(var l=0;l<i;l++)n.push({count:I(t,s),offset:I(t,s+4)}),s+=8;else for(var o=0;o<i;o++)n.push({count:I(t,s),offset:-(~I(t,s+4)+1)}),s+=8;e.entryCount=i,e.entries=n})}},{key:"stsc",value:function(r){return U(r,!0,function(e,t){for(var i=I(t),n=[],s=4,l=0;l<i;l++)n.push({firstChunk:I(t,s),samplesPerChunk:I(t,s+4),sampleDescriptionIndex:I(t,s+8)}),s+=12;e.entryCount=i,e.entries=n})}},{key:"stsz",value:function(r){return U(r,!0,function(e,t){var i=I(t),n=I(t,4),s=[];if(!i)for(var l=8,o=0;o<n;o++)s.push(I(t,l)),l+=4;e.sampleSize=i,e.sampleCount=n,e.entrySizes=s})}},{key:"stco",value:function(r){return U(r,!0,function(e,t){for(var i=I(t),n=[],s=4,l=0;l<i;l++)n.push(I(t,s)),s+=4;e.entryCount=i,e.entries=n})}},{key:"co64",value:function(r){return U(r,!0,function(e,t){for(var i=I(t),n=[],s=4,l=0;l<i;l++)n.push(ce(t,s)),s+=8;e.entryCount=i,e.entries=n})}},{key:"stss",value:function(r){return U(r,!0,function(e,t){for(var i=I(t),n=[],s=4,l=0;l<i;l++)n.push(I(t,s)),s+=4;e.entryCount=i,e.entries=n})}},{key:"moof",value:function(r){return U(r,!1,function(e,t,i){e.mfhd=u.mfhd(u.findBox(t,["mfhd"],i)[0]),e.traf=u.findBox(t,["traf"],i).map(function(n){return u.traf(n)})})}},{key:"mfhd",value:function(r){return U(r,!0,function(e,t){e.sequenceNumber=I(t)})}},{key:"traf",value:function(r){return U(r,!1,function(e,t,i){e.tfhd=u.tfhd(u.findBox(t,["tfhd"],i)[0]),e.tfdt=u.tfdt(u.findBox(t,["tfdt"],i)[0]),e.trun=u.trun(u.findBox(t,["trun"],i)[0])})}},{key:"trun",value:function(r){return U(r,!0,function(e,t){var i=e.version,n=e.flags,s=t.length,l=e.sampleCount=I(t),o=4;if(s>o&&n&1&&(e.dataOffset=-(~I(t,o)+1),o+=4),s>o&&n&4&&(e.firstSampleFlags=I(t,o),o+=4),e.samples=[],s>o)for(var h,c=0;c<l;c++)h={},n&256&&(h.duration=I(t,o),o+=4),n&512&&(h.size=I(t,o),o+=4),n&1024&&(h.flags=I(t,o),o+=4),n&2048&&(i?h.cts=-(~I(t,o+4)+1):h.cts=I(t,o),o+=4),e.samples.push(h)})}},{key:"tfdt",value:function(r){return U(r,!0,function(e,t){e.version===1?e.baseMediaDecodeTime=ce(t):e.baseMediaDecodeTime=I(t)})}},{key:"probe",value:function(r){return!!u.findBox(r,["ftyp"])}},{key:"parseSampleFlags",value:function(r){return{isLeading:(r[0]&12)>>>2,dependsOn:r[0]&3,isDependedOn:(r[1]&192)>>>6,hasRedundancy:(r[1]&48)>>>4,paddingValue:(r[1]&14)>>>1,isNonSyncSample:r[1]&1,degradationPriority:r[2]<<8|r[3]}}},{key:"moovToTrack",value:function(r,e,t){var i,n,s=r.trak;if(!(!s||!s.length)){var l=s.find(function(je){var le,he;return((le=je.mdia)===null||le===void 0||(he=le.hdlr)===null||he===void 0?void 0:he.handlerType)==="vide"}),o=s.find(function(je){var le,he;return((le=je.mdia)===null||le===void 0||(he=le.hdlr)===null||he===void 0?void 0:he.handlerType)==="soun"});if(l&&e){var h,c,v,f,d,S,m,g=e,D=(h=l.tkhd)===null||h===void 0?void 0:h.trackId;D!=null&&(g.id=l.tkhd.trackId),g.tkhdDuration=l.tkhd.duration,g.mvhdDurtion=r.mvhd.duration,g.mvhdTimecale=r.mvhd.timescale,g.timescale=g.formatTimescale=l.mdia.mdhd.timescale,g.duration=l.mdia.mdhd.duration||g.mvhdDurtion/g.mvhdTimecale*g.timescale,g.rotation=l.tkhd.rotation,g.matrix=l.tkhd.matrix;var b=l.mdia.minf.stbl.stsd.entries[0];if(g.width=b.width,g.height=b.height,b.pasp&&(g.sarRatio=[b.pasp.hSpacing,b.pasp.vSpacing]),b.av1C)g.codecType=Ee.AV1,g.codec=b.av1C.codec,g.av1C=b.av1C.data,g.colr=b.colr.data;else if(b.hvcC)g.codecType=Ee.HEVC,g.codec=b.hvcC.codec,g.vps=b.hvcC.vps,g.sps=b.hvcC.sps,g.pps=b.hvcC.pps,g.hvcC=b.hvcC.data;else if(b.avcC)g.codec=b.avcC.codec,g.sps=b.avcC.sps,g.pps=b.avcC.pps;else throw new Error("unknown video stsd entry");if(g.present=!0,g.ext={},g.ext.stss=(c=l.mdia)===null||c===void 0||(v=c.minf)===null||v===void 0||(f=v.stbl)===null||f===void 0?void 0:f.stss,g.ext.ctts=(d=l.mdia)===null||d===void 0||(S=d.minf)===null||S===void 0||(m=S.stbl)===null||m===void 0?void 0:m.ctts,b&&b.type==="encv"){var E,k,O,P,R,M,F,z;g.isVideoEncryption=!0,b.default_KID=(E=b.sinf)===null||E===void 0||(k=E.schi)===null||k===void 0?void 0:k.tenc.default_KID,b.default_IsEncrypted=(O=b.sinf)===null||O===void 0||(P=O.schi)===null||P===void 0?void 0:P.tenc.default_IsEncrypted,b.default_IV_size=(R=b.sinf)===null||R===void 0||(M=R.schi)===null||M===void 0?void 0:M.tenc.default_IV_size,g.videoSenc=l.mdia.minf.stbl.senc&&l.mdia.minf.stbl.senc.samples,b.data_format=(F=b.sinf)===null||F===void 0||(z=F.frma)===null||z===void 0?void 0:z.data_format,g.useEME=r.useEME,g.kidValue=r.kidValue,g.pssh=r.pssh,g.encv=b}}if(o&&t){var y,_,w,L,T,B,V,K,q,C=t,ne=(y=o.tkhd)===null||y===void 0?void 0:y.trackId;ne!=null&&(C.id=o.tkhd.trackId),C.tkhdDuration=o.tkhd.duration,C.mvhdDurtion=r.mvhd.duration,C.mvhdTimecale=r.mvhd.timescale,C.timescale=C.formatTimescale=o.mdia.mdhd.timescale,C.duration=o.mdia.mdhd.duration||C.mvhdDurtion/C.mvhdTimecale*C.timescale;var j=o.mdia.minf.stbl.stsd.entries[0];switch(C.sampleSize=j.sampleSize,C.sampleRate=j.sampleRate,C.channelCount=j.channelCount,C.present=!0,j.type){case"alaw":C.codecType=C.codec=pe.G711PCMA,C.sampleRate=8e3;break;case"ulaw":C.codecType=C.codec=pe.G711PCMU,C.sampleRate=8e3;break;default:C.sampleDuration=oe.getFrameDuration(C.sampleRate,C.timescale),C.sampleRateIndex=oe.getRateIndexByRate(C.sampleRate),C.objectType=((i=j.esds)===null||i===void 0?void 0:i.objectType)||2,j.esds&&(C.config=Array.from(j.esds.config)),C.codec=((n=j.esds)===null||n===void 0?void 0:n.codec)||"mp4a.40.2";break}if(C.sampleDuration=oe.getFrameDuration(C.sampleRate,C.timescale),C.objectType=((_=j.esds)===null||_===void 0?void 0:_.objectType)||2,j.esds&&(j.esds.config?C.config=Array.from(j.esds.config):console.warn("esds config is null")),C.codec=((w=j.esds)===null||w===void 0?void 0:w.codec)||"mp4a.40.2",C.sampleRateIndex=oe.getRateIndexByRate(C.sampleRate),C.ext={},C.ext.stss=(L=o.mdia)===null||L===void 0||(T=L.minf)===null||T===void 0||(B=T.stbl)===null||B===void 0?void 0:B.stss,C.ext.ctts=(V=o.mdia)===null||V===void 0||(K=V.minf)===null||K===void 0||(q=K.stbl)===null||q===void 0?void 0:q.ctts,C.present=!0,j&&j.type==="enca"){var Be,Ue,Ne,xe,Fe,Ve,Ge,He;C.isAudioEncryption=!0,j.data_format=(Be=j.sinf)===null||Be===void 0||(Ue=Be.frma)===null||Ue===void 0?void 0:Ue.data_format,j.default_KID=(Ne=j.sinf)===null||Ne===void 0||(xe=Ne.schi)===null||xe===void 0?void 0:xe.tenc.default_KID,j.default_IsEncrypted=(Fe=j.sinf)===null||Fe===void 0||(Ve=Fe.schi)===null||Ve===void 0?void 0:Ve.tenc.default_IsEncrypted,j.default_IV_size=(Ge=j.sinf)===null||Ge===void 0||(He=Ge.schi)===null||He===void 0?void 0:He.tenc.default_IV_size,C.audioSenc=o.mdia.minf.stbl.senc&&o.mdia.minf.stbl.senc.samples,C.useEME=r.useEME,C.kidValue=r.kidValue,C.enca=j}}if(t&&(t.isVideoEncryption=e?e.isVideoEncryption:!1),e&&(e.isAudioEncryption=t?t.isAudioEncryption:!1),e!=null&&e.encv||t!=null&&t.enca){var ze,Ye,ut=e==null||(ze=e.encv)===null||ze===void 0?void 0:ze.default_KID,ot=t==null||(Ye=t.enca)===null||Ye===void 0?void 0:Ye.default_KID,lt=ut||ot?(ut||ot).join(""):null;e&&(e.kid=lt),t&&(t.kid=lt)}return e&&(e.flags=3841),t&&(t.flags=1793),{videoTrack:e,audioTrack:t}}}},{key:"evaluateDefaultDuration",value:function(r,e,t){var i,n=e==null||(i=e.samples)===null||i===void 0?void 0:i.length;if(!n)return 1024;var s=1024*n/e.timescale;return s*r.timescale/t}},{key:"moofToSamples",value:function(r,e,t){var i={};return r.mfhd&&(e&&(e.sequenceNumber=r.mfhd.sequenceNumber),t&&(t.sequenceNumber=r.mfhd.sequenceNumber)),r.traf.forEach(function(n){var s=n.tfhd,l=n.tfdt,o=n.trun;if(!(!s||!o)){l&&(e&&e.id===s.trackId&&(e.baseMediaDecodeTime=l.baseMediaDecodeTime),t&&t.id===s.trackId&&(t.baseMediaDecodeTime=l.baseMediaDecodeTime));var h=s.defaultSampleSize||0,c=s.defaultSampleDuration||u.evaluateDefaultDuration(e,t,o.samples.length||o.sampleCount),v=o.dataOffset||0,f=0,d=-1;if(!o.samples.length&&o.sampleCount){i[s.trackId]=[];for(var S=0;S<o.sampleCount;S++)i[s.trackId].push({offset:v,dts:f,duration:c,size:h}),f+=c,v+=h}else i[s.trackId]=o.samples.map(function(m,g){return m={offset:v,dts:f,pts:f+(m.cts||0),duration:m.duration||c,size:m.size||h,gopId:d,keyframe:g===0||m.flags!==null&&m.flags!==void 0&&(m.flags&65536)>>>0!==65536},m.keyframe&&(d++,m.gopId=d),f+=m.duration,v+=m.size,m})}}),i}},{key:"moovToSamples",value:function(r){var e=r.trak;if(!(!e||!e.length)){var t=e.find(function(F){var z,y;return((z=F.mdia)===null||z===void 0||(y=z.hdlr)===null||y===void 0?void 0:y.handlerType)==="vide"}),i=e.find(function(F){var z,y;return((z=F.mdia)===null||z===void 0||(y=z.hdlr)===null||y===void 0?void 0:y.handlerType)==="soun"});if(!(!t&&!i)){var n,s;if(t){var l,o,h=(l=t.mdia)===null||l===void 0||(o=l.minf)===null||o===void 0?void 0:o.stbl;if(!h)return;var c=h.stts,v=h.stsc,f=h.stsz,d=h.stco,S=h.stss,m=h.ctts;if(!c||!v||!f||!d||!S)return;n=yt(c,v,f,d,m,S)}if(i){var g,D,b,E=(g=i.mdia)===null||g===void 0||(D=g.minf)===null||D===void 0?void 0:D.stbl;if(!E)return;var k=(b=i.mdia.mdhd)===null||b===void 0?void 0:b.timescale,O=E.stts,P=E.stsc,R=E.stsz,M=E.stco;if(!k||!O||!P||!R||!M)return;s=yt(O,P,R,M)}return{videoSamples:n,audioSamples:s}}}}}]),u}();function yt(u,a,r,e,t,i){var n=[],s=t==null?void 0:t.entries,l=a.entries,o=e.entries,h=r.entrySizes,c=i==null?void 0:i.entries,v;c&&(v={},c.forEach(function(P){v[P-1]=!0}));var f;s&&(f=[],s.forEach(function(P){for(var R=P.count,M=P.offset,F=0;F<R;F++)f.push(M)}));var d,S=-1,m=0,g=0,D=0,b=0,E=0,k=l[0].samplesPerChunk,O=l[1]?l[1].firstChunk-1:1/0;return u.entries.forEach(function(P){for(var R=P.count,M=P.delta,F=0;F<R;F++)d={dts:m,duration:M,size:h[g]||r.sampleSize,offset:o[D]+E,index:g},c&&(d.keyframe=v[g],d.keyframe&&S++,d.gopId=S),f&&g<f.length&&(d.pts=d.dts+f[g]),n.push(d),m+=M,g++,g<k?E+=d.size:(D++,E=0,D>=O&&(b++,O=l[b+1]?l[b+1].firstChunk-1:1/0),k+=l[b].samplesPerChunk)}),n}function Qe(u,a){return u.dataReferenceIndex=W(a,6),u.width=W(a,24),u.height=W(a,26),u.horizresolution=I(a,28),u.vertresolution=I(a,32),u.frameCount=W(a,40),u.depth=W(a,74),78}function St(u,a){return u.dataReferenceIndex=W(a,6),u.channelCount=W(a,16),u.sampleSize=W(a,18),u.sampleRate=I(a,24)/65536,28}function U(u,a,r){if(u){if(u.size!==u.data.length)throw new Error("box ".concat(u.type," size !== data.length"));var e={start:u.start,size:u.size,headerSize:u.headerSize,type:u.type};return a&&(e.version=u.data[u.headerSize],e.flags=jt(u.data,u.headerSize+1),e.headerSize+=4),r(e,u.data.subarray(e.headerSize),e.start+e.headerSize),e}}var Er=function(a,r,e){for(var t=String(e),i=r>>0,n=Math.ceil(i/t.length),s=[],l=String(a);n--;)s.push(t);return s.join("").substring(0,i-l.length)+l},$e=function(){for(var a=[],r=arguments.length,e=new Array(r),t=0;t<r;t++)e[t]=arguments[t];return e.forEach(function(i){a.push(Er(Number(i).toString(16),2,0))}),a[0]},kr=function(){function u(a,r,e){ve(this,u),ae(this,"__loadedMoofWraps",[]),ae(this,"__lastRemainData",null),ae(this,"__lastRemainDataStart",0),ae(this,"__nextMoofStart",-1),this.videoTrack=a||new wt,this.audioTrack=r||new Dt,this.metadataTrack=e||new Tt}return de(u,[{key:"demuxPart",value:function(r,e,t){var i=this,n=this.videoTrack,s=this.audioTrack,l=n.exist(),o=s.exist(),h=/av01/.test(n.codec);n.samples=[],s.samples=[];var c=r,v=e;if(this.__lastRemainData){var f=this.__lastRemainDataStart+this.__lastRemainData.byteLength,d=e<=f&&e>this.__lastRemainDataStart&&e+r.byteLength>f;if(d){var S=r.subarray(this.__lastRemainData.byteLength+this.__lastRemainDataStart-e);c=Ie(this.__lastRemainData,S),v=this.__lastRemainDataStart,this.__lastRemainData=null}else this.__lastRemainData=null,this.__lastRemainDataStart=0,this.__nextMoofStart=-1}if(!t){var m=X.findBox(c,["moov"])[0];if(!m)throw new Error("cannot found moov box");t=X.moov(m)}if(c){var g=v+c.byteLength;!l&&!o&&X.moovToTrack(t,n,s);var D=[];this.__nextMoofStart<0?X.findBox(c,["moof"],v).forEach(function(P){return D.push(P)}):this.__nextMoofStart>=v&&this.__nextMoofStart<=g-8&&X.findBox(c.subarray(this.__nextMoofStart-v),["moof"],this.__nextMoofStart).forEach(function(P){return D.push(P)}),D.filter(function(P){return P.size<=P.data.length}).forEach(function(P){var R=X.moof(P);i.__nextMoofStart=R.start+Math.max.apply(Math,Pe(R.traf.map(function(M){return M.trun.samples.reduce(function(F,z){return F+z.size},M.trun.dataOffset||0)}))),i.__loadedMoofWraps.push({start:R.start,nextMoofStart:i.__nextMoofStart,moof:R}),i.__loadedMoofWraps.sort(function(M,F){return M.start-F.start})});var b=Wt(this.__loadedMoofWraps),E;try{var k=function(){var R=E.value;if(R.start>g||R.nextMoofStart<v)return"continue";var M=R.start,F=X.moofToSamples(R.moof,n,s),z=n.baseMediaDecodeTime,y=s.baseMediaDecodeTime,_;Object.keys(F).forEach(function(w){n.id==w?F[w].some(function(L){var T=L.offset+=M;if(!(T<v)){if(T+L.size>g)return!0;var B=new rt((L.pts||L.dts)+z,L.dts+z);B.duration=L.duration,B.gopId=L.gopId,L.keyframe&&B.setToKeyframe();var V=c.subarray(T-v,T-v+L.size);if(B.data=V,!h)for(var K=0,q=V.length-1;K<q;)_=I(V,K),K+=4,B.units.push(V.subarray(K,K+_)),K+=_;i.__lastRemainDataStart=T+L.size,n.samples.push(B)}}):s.id==w&&F[w].some(function(L){var T=L.offset+M;if(!(T<v)){if(T+L.size>g)return!0;var B=c.subarray(T-v,T-v+L.size);s.samples.push(new be(L.dts+y,B,L.duration)),i.__lastRemainDataStart=T+L.size}})})};for(b.s();!(E=b.n()).done;)var O=k()}catch(P){b.e(P)}finally{b.f()}}return this.__lastRemainDataStart>v&&this.__lastRemainDataStart<c.byteLength+v?this.__lastRemainData=c.subarray(this.__lastRemainDataStart-v):(this.__lastRemainData=c,this.__lastRemainDataStart=v),n.samples.length&&(n.baseMediaDecodeTime=n.samples[0].pts),s.samples.length&&(s.baseMediaDecodeTime=s.samples[0].pts),{videoTrack:n,audioTrack:s,metadataTrack:this.metadataTrack}}},{key:"demux",value:function(r,e){var t=this.videoTrack,i=this.audioTrack,n=t.exist(),s=i.exist();if(t.samples=[],i.samples=[],e){if(!s){var l=X.findBox(e,["moov"])[0];if(!l)throw new Error("cannot found moov box");X.moovToTrack(X.moov(l),null,i)}var o=X.findBox(e,["moof"])[0];if(o){var h=X.moofToSamples(X.moof(o),null,i)[i.id],c=i.baseMediaDecodeTime;if(h){var v=o.start;h.map(function(E){E.offset+=v;var k=e.subarray(E.offset,E.offset+E.size);i.samples.push(new be(E.dts+c,k,E.duration))})}}}if(r){if(!n&&!s){var f=X.findBox(r,["moov"])[0];if(!f)throw new Error("cannot found moov box");X.moovToTrack(X.moov(f),t,i)}var d=X.findBox(r,["moof"])[0];if(d){var S=X.moofToSamples(X.moof(d),t,i),m=t.baseMediaDecodeTime,g=i.baseMediaDecodeTime,D=d.start,b;Object.keys(S).forEach(function(E){t.id==E?S[E].map(function(k){k.offset+=D;var O=new rt((k.pts||k.dts)+m,k.dts+m);O.duration=k.duration,O.gopId=k.gopId,k.keyframe&&O.setToKeyframe();var P=r.subarray(k.offset,k.offset+k.size);O.data=P;for(var R=0,M=P.length-1;R<M;)b=I(P,R),R+=4,O.units.push(P.subarray(R,R+b)),R+=b;t.samples.push(O)}):i.id==E&&S[E].map(function(k){k.offset+=D;var O=r.subarray(k.offset,k.offset+k.size);i.samples.push(new be(k.dts+g,O,k.duration))})})}}return{videoTrack:t,audioTrack:i,metadataTrack:this.metadataTrack}}},{key:"reset",value:function(){this.videoTrack.reset(),this.audioTrack.reset(),this.metadataTrack.reset()}}],[{key:"probe",value:function(r){return X.probe(r)}}]),u}(),wr=function(){function u(){Q(this,u);var a=window.crypto||window.msCrypto;this.subtle=a&&(a.subtle||a.webkitSubtle),this.externalDecryptor=null}return $(u,[{key:"destroy",value:function(){var r;(r=this.externalDecryptor)!==null&&r!==void 0&&r.destroy&&this.externalDecryptor.destroy()}},{key:"decrypt",value:function(r,e){if(!(!r&&!e)){var t=[];return r&&(t[0]=this._decryptSegment(r)),e&&(t[1]=this._decryptSegment(e)),Promise.all(t)}}},{key:"_decryptSegment",value:function(){var a=H(A().mark(function e(t){var i;return A().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(i=t.data,!t.key){s.next=5;break}return s.next=4,this._decryptData(t.data,t.key,t.keyIv);case 4:i=s.sent;case 5:if(t.map){s.next=7;break}return s.abrupt("return",i);case 7:return s.abrupt("return",Ce(t.map,i));case 8:case"end":return s.stop()}},e,this)}));function r(e){return a.apply(this,arguments)}return r}()},{key:"_decryptData",value:function(){var a=H(A().mark(function e(t,i,n){var s;return A().wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(!this.externalDecryptor){o.next=6;break}return o.next=3,this.externalDecryptor.decrypt(t,i,n);case 3:return o.abrupt("return",o.sent);case 6:if(this.subtle){o.next=8;break}throw new Error("crypto is not defined");case 8:return o.next=10,this.subtle.importKey("raw",i,{name:"AES-CBC"},!1,["encrypt","decrypt"]);case 10:return s=o.sent,o.t0=Uint8Array,o.next=14,this.subtle.decrypt({name:"AES-CBC",iv:n},s,t);case 14:return o.t1=o.sent,o.abrupt("return",new o.t0(o.t1));case 16:case"end":return o.stop()}},e,this)}));function r(e,t,i){return a.apply(this,arguments)}return r}()}]),u}(),G=Y(Y({},x),{},{STREAM_PARSED:"core.streamparsed",NO_AUDIO_TRACK:"core.noaudiotrack",SUBTITLE_SEGMENTS:"core.subtitlesegments",SUBTITLE_PLAYLIST:"core.subtitleplaylist",SEI_PAYLOAD_TIME:"core.seipayloadtime",APPEND_COST:"core.appendcost"}),Je=new ye("Transmuxer"),_t=function(){function u(a,r,e,t){Q(this,u),p(this,"_initSegmentId",""),this.hls=a,this._demuxer=r?new kr:new It(null,null,null,t),this._isMP4=r,e&&(this._remuxer=new qt(this._demuxer.videoTrack,this._demuxer.audioTrack))}return $(u,[{key:"transmux",value:function(r,e,t,i,n,s){var l=this._demuxer;try{this._isMP4?l.demux(r,e):l.demuxAndFix(Ce(r,e),t,i,n)}catch(O){throw new J(ie.DEMUX,ie.SUB_TYPES.HLS,O)}var o=l.videoTrack,h=l.audioTrack,c=l.metadataTrack,v={codec:o.codec,timescale:o.timescale,firstDts:o.firstDts/o.timescale,firstPts:o.firstPts/o.timescale,duration:o.samplesDuration/o.timescale},f={codec:h.codec,timescale:h.timescale,firstDts:h.firstDts/o.timescale,firstPts:h.firstPts/o.timescale,duration:h.samplesDuration/o.timescale,container:h.container},d="".concat(o.codec,"/").concat(o.width,"/").concat(o.height,"/").concat(h.codec,"/").concat(h.config);if(d!==this._initSegmentId&&(this._initSegmentId=d,s=!0),this._fireEvents(o,h,c,t||s),this.hls.emit(G.DEMUXED_TRACK,{videoTrack:o,audioTrack:h}),this._remuxer){s&&this.hls.isLive&&!this.hls.config.mseLowLatency&&(o.duration=this.hls.totalDuration*o.timescale,h.duration=this.hls.totalDuration*h.timescale);try{var S=this._remuxer.remux(s),m=S.videoInitSegment,g=S.videoSegment,D=S.audioInitSegment,b=S.audioSegment,E=Ce(m,g),k=Ce(D,b);return[E?Y(Y({},v),{},{data:E}):void 0,k?Y(Y({},f),{},{data:k}):void 0]}catch(O){throw new J(ie.REMUX,ie.SUB_TYPES.FMP4,O)}}else return[o,h]}},{key:"_fireEvents",value:function(r,e,t,i){var n=this,s=[r,e],l="discontinuity: ".concat(i);s.forEach(function(o){var h;(h=o.samples)!==null&&h!==void 0&&h.length&&(l+="; ".concat(o.samples.length," ").concat(o.type===ft.VIDEO?"video":"audio"," samples, firstDts/firstPts/duration: ").concat((o.firstDts/o.timescale).toFixed(3),"/").concat((o.firstPts/o.timescale).toFixed(3),"/").concat((o.samplesDuration/o.timescale).toFixed(3))),i&&o.exist()&&n.hls.emit(G.METADATA_PARSED,{type:o.type,track:o,meta:Y({codec:o.codec,timescale:o.timescale,baseDts:o.baseDts},o.type===ft.VIDEO?{width:o.width,height:o.height,sarRatio:o.sarRatio}:{codec:o.codec,channelCount:o.channelCount,sampleRate:o.sampleRate})})}),Je.debug(l),r.warnings.forEach(function(o){var h;switch(o.type){case re.LARGE_AV_SHIFT:h=G.LARGE_AV_FIRST_FRAME_GAP_DETECT;break;case re.LARGE_VIDEO_GAP:h=G.LARGE_VIDEO_DTS_GAP_DETECT;break;case re.LARGE_VIDEO_GAP_BETWEEN_CHUNK:h=G.MAX_DTS_DELTA_WITH_NEXT_SEGMENT_DETECT;break}h&&n.hls.emit(G.STREAM_EXCEPTION,Y(Y({},o),{},{type:h})),Je.warn("video exception",o)}),e.warnings.forEach(function(o){var h;switch(o.type){case re.LARGE_AUDIO_GAP:h=G.LARGE_AUDIO_DTS_GAP_DETECT;break;case re.AUDIO_FILLED:h=G.AUDIO_GAP_DETECT;break;case re.AUDIO_DROPPED:h=G.AUDIO_OVERLAP_DETECT;break}h&&n.hls.emit(G.STREAM_EXCEPTION,Y(Y({},o),{},{type:h})),Je.warn("audio exception",o)}),r.samples.forEach(function(o){o.keyframe&&n.hls.emit(G.KEYFRAME,{pts:o.pts})}),t.seiSamples.forEach(function(o){n.hls.emit(G.SEI,Y(Y({},o),{},{originPts:o.originPts/90,sei:{code:o.data.type,content:o.data.payload,dts:o.pts}}))})}}]),u}(),Dr=["data"],Tr=["data"],bt=new ye("BufferService"),Lr=function(){function u(a){var r=this;Q(this,u),p(this,"_decryptor",new wr),p(this,"_transmuxer",null),p(this,"_mse",null),p(this,"_softVideo",null),p(this,"_sourceCreated",!1),p(this,"_needInitSegment",!0),p(this,"_directAppend",!1),this.hls=a,a.config.softDecode?this._softVideo=a.media:(this._mse=new ee(null,{preferMMS:a.config.preferMMS}),a.config.url&&this._mse.bindMedia(a.media).then(function(e){r.hls.emit(x.MEDIASOURCE_OPENED,e)})),a.config.decryptor&&(this._decryptor.externalDecryptor=a.config.decryptor)}return $(u,[{key:"baseDts",get:function(){var r,e,t;return(r=this._transmuxer)===null||r===void 0||(e=r._demuxer)===null||e===void 0||(t=e._fixer)===null||t===void 0?void 0:t._baseDts}},{key:"nbSb",get:function(){var r;return(r=this._mse)!==null&&r!==void 0&&r._sourceBuffer?Object.keys(this._mse._sourceBuffer).length:0}},{key:"msIsOpened",get:function(){var r;return(r=this._mse)===null||r===void 0?void 0:r.isOpened}},{key:"msHasOpTasks",get:function(){var r;return(r=this._mse)===null||r===void 0?void 0:r.hasOpTasks}},{key:"msStreaming",get:function(){var r;return(r=this._mse)===null||r===void 0?void 0:r.streaming}},{key:"updateDuration",value:function(){var a=H(A().mark(function e(t){return A().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(bt.debug("update duration",t),!this._mse){n.next=9;break}if(this._mse.isOpened){n.next=5;break}return n.next=5,this._mse.open();case 5:return n.next=7,this._mse.updateDuration(t);case 7:n.next=10;break;case 9:this._softVideo&&(this._softVideo.duration=t);case 10:case"end":return n.stop()}},e,this)}));function r(e){return a.apply(this,arguments)}return r}()},{key:"createSource",value:function(r,e,t,i){if(!this._sourceCreated){var n=r||e;if(n){if(It.probe(n))this._transmuxer||(this._transmuxer=new _t(this.hls,!1,!this._softVideo,this.hls.config.fixerConfig));else if(X.probe(n))if(this._softVideo)this._transmuxer||(this._transmuxer=new _t(this.hls,!0,null,this.hls.config.fixerConfig));else{this._directAppend=!0;var s=!1;r&&!t&&X.findBox(r,["moov","trak"]).forEach(function(l){var o=X.findBox(l.data,["trak","mdia","minf","stbl","stsd"])[0];if(o){var h=X.stsd(o).entries[0];if(h){if(h.hvcC)t=h.hvcC.codec||"hev1.1.6.L93.B0";else if(h.avcC)t=h.avcC.codec;else if(h.sampleRate||h.esds){var c;i=((c=h.esds)===null||c===void 0?void 0:c.codec)||"mp4a.40.2",s=!0}}}}),e&&!i&&X.findBox(e,["moov","trak","mdia","minf","stbl","stsd"]).forEach(function(l){var o=X.stsd(l).entries[0];o&&o.esds&&(i=o.esds.codec)}),r&&!t&&(t="avc1.42e01e"),e&&!i&&(i="mp4a.40.2"),s&&(t+=", ".concat(i),i=""),this._createMseSource(t,i)}else throw new J(ie.OTHER,null,null,null,"unsupported stream");this._softVideo&&(this._sourceCreated=!0)}}}},{key:"appendBuffer",value:function(){var a=H(A().mark(function e(t,i,n,s,l,o,h){var c=this,v,f,d,S,m,g,D,b,E,k,O,P,R,M,F;return A().wrap(function(y){for(;;)switch(y.prev=y.next){case 0:if(!(!(n!=null&&n.length)&&!(s!=null&&s.length))){y.next=2;break}return y.abrupt("return");case 2:if(v=function(){var w;if((w=c.hls)!==null&&w!==void 0&&w.emit){var L;(L=c.hls)===null||L===void 0||L.emit(x.APPEND_BUFFER,{start:t.start,end:t.end})}},!this._directAppend){y.next=8;break}return f=[],n&&f.push(this._mse.append(ee.VIDEO,n)),s&&f.push(this._mse.append(ee.AUDIO,s)),y.abrupt("return",Promise.all(f).then(v));case 8:if(d=this._needInitSegment||l,S=this._transmuxer.transmux(n,s,d,o,h,this._needInitSegment||l),m=ue(S,2),g=m[0],D=m[1],s&&i&&(i==null||i.setTrackExist(!1,!0)),s&&t&&(t==null||t.setTrackExist(!0,!1)),i||t==null||t.setTrackExist(!!g,!!D),g&&!D&&this.hls.emit(G.NO_AUDIO_TRACK),!this._softVideo){y.next=20;break}this._softVideo.appendBuffer(g,D),this._needInitSegment=!1,v(),y.next=32;break;case 20:if(!this._mse){y.next=32;break}return b=!this._sourceCreated,b&&this._createMseSource(g==null?void 0:g.codec,D==null?void 0:D.codec,D==null?void 0:D.container),this._needInitSegment=!1,E=this._mse,k=[],d&&!b&&this._handleCodecChange(g,D).forEach(function(_){return k.push(_)}),g&&(O=g.data,P=nt(g,Dr),k.push(E.append(ee.VIDEO,O,P))),D&&(R=D.data,M=nt(D,Tr),k.push(E.append(ee.AUDIO,R,M))),F=Promise.all(k),F.then(v),y.abrupt("return",F);case 32:case"end":return y.stop()}},e,this)}));function r(e,t,i,n,s,l,o){return a.apply(this,arguments)}return r}()},{key:"removeBuffer",value:function(){var a=H(A().mark(function e(){var t=this,i,n,s,l=arguments;return A().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:if(i=l.length>0&&l[0]!==void 0?l[0]:0,n=l.length>1&&l[1]!==void 0?l[1]:1/0,s=this.hls.media,!(!this._mse||!s||i<0||n<i||i>=this._mse.duration)){h.next=5;break}return h.abrupt("return");case 5:return h.abrupt("return",this._mse.clearBuffer(i,n).then(function(){return t.hls.emit(x.REMOVE_BUFFER,{start:i,end:n,removeEnd:n})}));case 6:case"end":return h.stop()}},e,this)}));function r(){return a.apply(this,arguments)}return r}()},{key:"evictBuffer",value:function(){var a=H(A().mark(function e(t){var i,n,s,l;return A().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:if(i=this.hls.media,!(!this._mse||!i||!t||t<0)){h.next=3;break}return h.abrupt("return");case 3:if(n=i.currentTime,s=n-t,!(s<=0)){h.next=7;break}return h.abrupt("return");case 7:if(l=fe.start(fe.get(i)),!(l+1>=s)){h.next=10;break}return h.abrupt("return");case 10:return h.abrupt("return",this.removeBuffer(0,s));case 11:case"end":return h.stop()}},e,this)}));function r(e){return a.apply(this,arguments)}return r}()},{key:"clearAllBuffer",value:function(){var a=H(A().mark(function e(){return A().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(!this._mse){i.next=2;break}return i.abrupt("return",this._mse.clearAllBuffer());case 2:case"end":return i.stop()}},e,this)}));function r(){return a.apply(this,arguments)}return r}()},{key:"decryptBuffer",value:function(r,e){return this._decryptor.decrypt(r,e)}},{key:"reset",value:function(){var a=H(A().mark(function e(){var t,i=arguments;return A().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(t=i.length>0&&i[0]!==void 0?i[0]:!1,!(this._mse&&!t)){s.next=8;break}return this._transmuxer=null,this._sourceCreated=!1,s.next=6,this._mse.unbindMedia();case 6:return s.next=8,this._mse.bindMedia(this.hls.media);case 8:this._needInitSegment=!0,this._directAppend=!1;case 10:case"end":return s.stop()}},e,this)}));function r(){return a.apply(this,arguments)}return r}()},{key:"endOfStream",value:function(){var a=H(A().mark(function e(){return A().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(!this._mse){i.next=5;break}if(!this._sourceCreated){i.next=5;break}return i.next=4,this._mse.endOfStream();case 4:this.hls.emit(x.BUFFEREOS);case 5:this._softVideo&&this._softVideo.endOfStream();case 6:case"end":return i.stop()}},e,this)}));function r(){return a.apply(this,arguments)}return r}()},{key:"setLiveSeekableRange",value:function(){var a=H(A().mark(function e(t,i){return A().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:this._mse&&this._mse.setLiveSeekableRange(t,i);case 1:case"end":return s.stop()}},e,this)}));function r(e,t){return a.apply(this,arguments)}return r}()},{key:"detachMedia",value:function(){var a=H(A().mark(function e(){return A().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(!this._mse){i.next=3;break}return i.next=3,this._mse.unbindMedia();case 3:case"end":return i.stop()}},e,this)}));function r(){return a.apply(this,arguments)}return r}()},{key:"destroy",value:function(){var a=H(A().mark(function e(){var t;return A().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return(t=this._decryptor)===null||t===void 0||t.destroy(),n.next=3,this.detachMedia();case 3:this._decryptor=null,this._mse=null,this._softVideo=null;case 6:case"end":return n.stop()}},e,this)}));function r(){return a.apply(this,arguments)}return r}()},{key:"_createMseSource",value:function(r,e,t){bt.debug("create mse source, videoCodec=".concat(r,", audioCodec=").concat(e));var i=this._mse;i&&(r&&(i.createSource(ee.VIDEO,"video/mp4;codecs=".concat(r)),this._sourceCreated=!0),e?(i.createSource(ee.AUDIO,"audio/mp4;codecs=".concat(e)),this._sourceCreated=!0):t&&(i.createSource(ee.AUDIO,"".concat(t,';codecs=""')),this._sourceCreated=!0),this.hls.emit(x.SOURCEBUFFER_CREATED))}},{key:"_handleCodecChange",value:function(r,e){var t=[],i=this._mse,n=[{type:ee.VIDEO,codecs:r==null?void 0:r.codec},{type:ee.AUDIO,codecs:e==null?void 0:e.codec}];return n.filter(function(s){return!!s.codecs}).forEach(function(s){var l=s.type,o=s.codecs,h=i.getSourceBuffer(l);if(h){var c=o.split(",")[0];new RegExp(c,"ig").test(h.mimeType)||t.push(i.changeType(l,"".concat(l,"/mp4;codecs=").concat(o)))}}),t}},{key:"seamlessSwitch",value:function(){this._needInitSegment=!0}},{key:"isFull",value:function(){var r,e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ee.VIDEO;return(r=this._mse)===null||r===void 0?void 0:r.isFull(e)}}]),u}();function Ar(u){var a=(u==null?void 0:u.media)||document.createElement("video");return Y(Y({maxPlaylistSize:50,retryCount:3,retryDelay:1e3,pollRetryCount:2,loadTimeout:1e4,manifestLoadTimeout:1e4,preloadTime:30,softDecode:!1,bufferBehind:10,maxJumpDistance:3,startTime:0,useLowLatency:!0,targetLatency:10,maxLatency:20,allowedStreamTrackChange:!0,seiInTime:!1,manifestList:[],minSegmentsStartPlay:3,preferMMS:!1,preferMMSStreaming:!1,mseLowLatency:!0,fixerConfig:{forceFixLargeGap:!1,largeGapThreshold:5}},u),{},{media:a})}var Ir=$(function u(){Q(this,u),p(this,"version",0),p(this,"streams",[]),p(this,"isMaster",!0)}),Pt={Audio:"AUDIO",Video:"VIDEO",SubTitle:"SUBTITLE",ClosedCaptions:"CLOSED-CAPTIONS"},Te={CLEAR_KEY:"org.w3.clearkey",FAIRPLAY:["urn:uuid:94ce86fb-07ff-4f43-adb8-93d2fa968ca2","com.apple.streamingkeydelivery"],WIDEVINE:["urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed","com.widevine.alpha","com.widevine"],PLAYREADY:["urn:uuid:9a04f079-9840-4286-ab92-e65be0885f95","com.microsoft.playready"]};function Ct(u){for(var a=[],r=0;r<u.length;r++)Array.isArray(u[r])?a=a.concat(Ct(u[r])):a.push(u[r]);return a}var at=$(function u(){Q(this,u),p(this,"id",0),p(this,"url",""),p(this,"default",!1),p(this,"autoSelect",!1),p(this,"forced",!1),p(this,"group",""),p(this,"name",""),p(this,"lang",""),p(this,"segments",[]),p(this,"endSN",0)}),Pr=function(u){Oe(r,u);var a=Me(r);function r(){var e;Q(this,r);for(var t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return e=a.call.apply(a,[this].concat(i)),p(N(e),"mediaType",Pt.Audio),p(N(e),"channels",0),e}return $(r)}(at),Cr=function(u){Oe(r,u);var a=Me(r);function r(){var e;Q(this,r);for(var t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return e=a.call.apply(a,[this].concat(i)),p(N(e),"mediaType",Pt.SubTitle),e}return $(r)}(at),Rr=$(function u(){Q(this,u),p(this,"id",0),p(this,"bitrate",0),p(this,"width",0),p(this,"height",0),p(this,"name",""),p(this,"url",""),p(this,"audioCodec",""),p(this,"videoCodec",""),p(this,"textCodec",""),p(this,"audioGroup",""),p(this,"audioStreams",[]),p(this,"subtitleStreams",[]),p(this,"closedCaptionsStream",[])}),Or=$(function u(){Q(this,u),p(this,"version",0),p(this,"url",""),p(this,"type",""),p(this,"startCC",0),p(this,"endCC",0),p(this,"startSN",0),p(this,"endSN",0),p(this,"totalDuration",0),p(this,"targetDuration",0),p(this,"partTargetDuration",0),p(this,"canSkipUntil",0),p(this,"canSkipDateRanges",!1),p(this,"skippedSegments",0),p(this,"canBlockReload",!1),p(this,"partHoldBack",0),p(this,"live",!0),p(this,"lowLatency",!1),p(this,"endPartIndex",0),p(this,"segments",[]),p(this,"dateRanges",{}),p(this,"skippedSegments",0)}),Le=function(){function u(a){Q(this,u),p(this,"sn",0),p(this,"cc",0),p(this,"url",""),p(this,"parentUrl",""),p(this,"title",""),p(this,"start",0),p(this,"duration",0),p(this,"dataTime",""),p(this,"key",null),p(this,"byteRange",null),p(this,"isInitSegment",!1),p(this,"initSegment",null),p(this,"isLast",!1),p(this,"hasAudio",!1),p(this,"hasVideo",!1),p(this,"independent",!1),p(this,"partIndex",0),this.parentUrl=a}return $(u,[{key:"end",get:function(){return this.start+this.duration}},{key:"setTrackExist",value:function(r,e){this.hasVideo=r,this.hasAudio=e}},{key:"setByteRange",value:function(r,e){this.byteRange=[0];var t=r.split("@");t.length===1&&e&&e.byteRange?(this.byteRange[0]=e.byteRange[1]||0,this.byteRange[0]&&(this.byteRange[0]+=1)):this.byteRange[0]=parseInt(t[1]),this.byteRange[1]=this.byteRange[0]+parseInt(t[0])-1}}]),u}(),Mr=function(){function u(a){Q(this,u),p(this,"method",""),p(this,"url",""),p(this,"iv",null),p(this,"keyFormat",""),p(this,"keyFormatVersions",""),a instanceof u&&(this.method=a.method,this.url=a.url,this.keyFormat=a.keyFormat,this.keyFormatVersions=a.keyFormatVersions,a.iv&&(this.iv=new Uint8Array(a.iv)))}return $(u,[{key:"clone",value:function(r){var e=new u(this);return r!=null&&e.setIVFromSN(r),e}},{key:"setIVFromSN",value:function(r){if(!this.iv&&this.method==="AES-128"&&typeof r=="number"&&this.url){this.iv=new Uint8Array(16);for(var e=12;e<16;e++)this.iv[e]=r>>8*(15-e)&255}}},{key:"isSegmentEncrypted",value:function(){var r=this.method;return r==="AES-128"}},{key:"isValidKeySystem",value:function(){var r=Ct([Te.CLEAR_KEY,Te.FAIRPLAY,Te.WIDEVINE,Te.PLAYREADY]).indexOf(this.keyFormat)>-1;if(!r)return!1;var e=["SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)>-1;return!!e}},{key:"isSupported",value:function(){return this.method?this.isSegmentEncrypted()?!0:!!this.isValidKeySystem():!1}}]),u}(),Br=function(){function u(a,r,e){Q(this,u),this.msn=a,this.part=r,this.skip=e}return $(u,[{key:"addDirectives",value:function(r){var e=new self.URL(r);return this.msn!==void 0&&e.searchParams.set("_HLS_msn",this.msn.toString()),this.part&&e.searchParams.set("_HLS_part",this.part.toString()),this.skip&&e.searchParams.set("_HLS_skip",this.skip),e.href}}]),u}(),Ur=/^#(EXT[^:]*)(?::(.*))?$/,Et=/([^=]+)=(?:"([^"]*)"|([^",]*))(?:,|$)/g,Nr=/^(?:[a-zA-Z0-9+\-.]+:)?\/\//,xr=/^((?:[a-zA-Z0-9+\-.]+:)?\/\/[^/?#]*)?([^?#]*\/)?/;function Fr(u){return u.split(/[\r\n]/).map(function(a){return a.trim()}).filter(Boolean)}function Rt(u){var a=u.match(Ur);if(!(!a||!a[1]))return[a[1].replace("EXT-X-",""),a[2]]}function se(u){for(var a={},r=Et.exec(u);r;)a[r[1]]=r[2]||r[3],r=Et.exec(u);return a}function me(u,a){if(!a||!u||Nr.test(u))return u;var r=xr.exec(a);return r?u[0]==="/"?r[1]+u:r[1]+r[2]+u:u}var Vr={audio:[/^mp4a/,/^vorbis$/,/^opus$/,/^flac$/,/^[ae]c-3$/],video:[/^avc/,/^hev/,/^hvc/,/^vp0?[89]/,/^av1$/],text:[/^vtt$/,/^wvtt/,/^stpp/]};function Ze(u,a){var r=Vr[u];if(!(!r||!a||!a.length)){for(var e=0;e<r.length;e++)for(var t=0;t<a.length;t++)if(r[e].test(a[t]))return a[t]}}function Gr(u,a){var r;if(a){for(var e in a)if(Object.prototype.hasOwnProperty.call(a,e)&&u[e]!==a[e]){r=e;break}}var t=null;u.DURATION&&(t=parseFloat(u.DURATION),Number.isFinite(t)?u._endDate&&(t=(u._endDate.getTime()-u._startDate.getTime())/1e3):t=null);var i=Hr(u.CUE||u["X-CUE"],{pre:!1,post:!1,once:!1});return!!u.ID&&!r&&Number.isFinite(u._startDate.getTime())&&(t===null||t>=0)&&(u.END_ON_NEXT!=="YES"||!!u.CLASS)&&(!u.CUE||!i.pre&&!i.post||i.pre!==i.post)&&(u.CLASS!=="com.apple.hls.interstitial"||"X-ASSET-URI"in u||"X-ASSET-LIST"in u)}function Hr(u,a){return(u?u.split(/[ ,]+/):[]).reduce(function(r,e){return r[e.toLowerCase()]=!0,r},a)}function zr(u,a){for(var r=new Ir,e=0,t,i=[],n=[];t=u[e++];){var s=Rt(t);if(s){var l=ue(s,2),o=l[0],h=l[1];if(o==="VERSION")r.version=parseInt(h);else if(o==="MEDIA"&&h){var c=se(h),v=void 0;switch(c.TYPE){case"AUDIO":v=new Pr;break;case"SUBTITLES":v=new Cr;break;default:v=new at}v.url=me(c.URI,a),v.default=c.DEFAULT==="YES",v.autoSelect=c.AUTOSELECT==="YES",v.group=c["GROUP-ID"],v.name=c.NAME,v.lang=c.LANGUAGE,c.CHANNELS&&(v.channels=Number(c.CHANNELS.split("/")[0]),Number.isNaN(v.channels)&&(v.channels=0)),c.TYPE==="AUDIO"&&c.URI&&i.push(v),c.TYPE==="SUBTITLES"&&n.push(v)}else if(o==="STREAM-INF"&&h){var f=new Rr,d=se(h);if(f.bitrate=parseInt(d["AVERAGE-BANDWIDTH"]||d.BANDWIDTH),f.name=d.NAME,f.url=me(u[e++],a),d.RESOLUTION){var S=d.RESOLUTION.split("x"),m=ue(S,2),g=m[0],D=m[1];f.width=parseInt(g),f.height=parseInt(D)}if(d.CODECS){var b=d.CODECS.split(/[ ,]+/).filter(Boolean);f.videoCodec=Ze("video",b),f.audioCodec=Ze("audio",b),f.textCodec=Ze("text",b)}f.audioGroup=d.AUDIO,f.subtitleGroup=d.SUBTITLES,r.streams.push(f)}}}return r.streams.forEach(function(E,k){E.id=k}),i.length&&(i.forEach(function(E,k){E.id=k}),r.streams.forEach(function(E){E.audioGroup&&(E.audioStreams=i.filter(function(k){return k.group===E.audioGroup}))})),n.length&&(n.forEach(function(E,k){E.id=k}),r.streams.forEach(function(E){E.subtitleGroup&&(E.subtitleStreams=n.filter(function(k){return k.group===E.subtitleGroup}))})),r}function Yr(u,a,r){var e=new Or;e.url=a;for(var t=new Le(a),i=null,n=null,s=0,l=0,o=0,h=0,c,v=!1,f=0;c=u[h++];){if(c[0]!=="#"){if(e.lowLatency){l++;continue}t.sn=l,t.cc=o,t.url=me(c,a),n&&(t.key=n.clone(l)),i&&(t.initSegment=i),e.segments.push(t),t=new Le(a),l++;continue}var d=Rt(c);if(d){var S=ue(d,2),m=S[0],g=S[1];switch(m){case"VERSION":e.version=parseInt(g);break;case"PLAYLIST-TYPE":e.type=g==null?void 0:g.toUpperCase();break;case"TARGETDURATION":e.targetDuration=parseFloat(g);break;case"PART-INF":{r&&(e.lowLatency=!0);var D=se(g);D["PART-TARGET"]&&(e.partTargetDuration=parseFloat(D["PART-TARGET"]))}break;case"SERVER-CONTROL":{var b=se(g);e.canBlockReload=b["CAN-BLOCK-RELOAD"]==="YES",e.partHoldBack=parseFloat(b["PART-HOLD-BACK"]||0),e.canSkipUntil=parseFloat(b["CAN-SKIP-UNTIL"]||0),e.canSkipDateRanges=e.canSkipUntil>0&&b["CAN-SKIP-DATERANGES"]==="YES"}break;case"ENDLIST":v=!0;break;case"MEDIA-SEQUENCE":l=e.startSN=parseInt(g);break;case"DISCONTINUITY-SEQUENCE":o=e.startCC=parseInt(g);break;case"DISCONTINUITY":o++;break;case"BYTERANGE":t.setByteRange(g,e.segments[e.segments.length-1]);break;case"PART":{if(!e.lowLatency)break;var E=se(g);t.duration=parseFloat(E.DURATION),t.independent=E.INDEPENDENT==="YES",t.sn=l,t.cc=o,t.partIndex=f,t.start=s,t.duration=parseFloat(E.DURATION),s+=t.duration,t.url=me(E.URI,a),n&&(t.key=n.clone(l)),i&&(t.initSegment=i),e.segments.push(t),t=new Le(a),f++}break;case"PRELOAD-HINT":{var k=se(g);if(e.preloadHint=k,k.TYPE==="PART"&&k.URI){var O=k.URI.split(".ts")[0].split("-");e.nextSN=O[3],e.nextIndex=O[O.length-1]}}break;case"PROGRAM-DATE-TIME":t.dataTime=g;break;case"EXTINF":{if(e.lowLatency){f=0;break}var P=g.split(","),R=ue(P,2),M=R[0],F=R[1];t.start=s,t.duration=parseFloat(M),s+=t.duration,t.title=F}break;case"KEY":{var z=se(g);if(z.METHOD==="NONE"){n=null;break}if(n=new Mr,n.method=z.METHOD,n.url=/^blob:/.test(z.URI)?z.URI:me(z.URI,a),n.keyFormat=z.KEYFORMAT||"identity",n.keyFormatVersions=z.KEYFORMATVERSIONS,!n.isSupported())throw new Error("encrypt ".concat(z.METHOD,"/").concat(z.KEYFORMAT," is not supported"));if(z.IV){var y=z.IV.slice(2);y=(y.length&1?"0":"")+y,n.iv=new Uint8Array(y.length/2);for(var _=0,w=y.length/2;_<w;_++)n.iv[_]=parseInt(y.slice(_*2,_*2+2),16)}}break;case"MAP":{var L=se(g);t.url=me(L.URI,a),L.BYTERANGE&&t.setByteRange(L.BYTERANGE),t.isInitSegment=!0,t.sn=0,n&&(t.key=n.clone(0)),i=t,t=new Le(a)}break;case"SKIP":{var T=se(g),B=parseInt(T["SKIPPED-SEGMENTS"],10);B<=Number.MAX_SAFE_INTEGER&&(e.skippedSegments+=B,l+=B)}break;case"DATERANGE":{var V=se(g),K=e.dateRanges[V.ID];V._startDate=K?K._startDate:new Date(V["START-DATE"]);var q=(K==null?void 0:K._endDate)||new Date(V.END_DATE);Number.isFinite(q)&&(V._endDate=q),(Gr(V,K)||e.skippedSegments)&&(e.dateRanges[V.ID]=V)}break}}}e.segments=e.segments.filter(function(ne){return ne.duration!==0});var C=e.segments[e.segments.length-1];return C&&(v&&(C.isLast=!0),e.endSN=C.sn,e.endPartIndex=C.partIndex),v&&(e.live=!1),e.totalDuration=s,e.endCC=o,e}var Ae=function(){function u(){Q(this,u)}return $(u,null,[{key:"parse",value:function(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"",e=arguments.length>1?arguments[1]:void 0,t=arguments.length>2?arguments[2]:void 0;if(!r.includes("#EXTM3U"))throw new Error("Invalid m3u8 file");var i=Fr(r);return u.isMediaPlaylist(r)?Yr(i,e,t):zr(i,e)}},{key:"isMediaPlaylist",value:function(r){return r.includes("#EXTINF:")||r.includes("#EXT-X-TARGETDURATION:")}}]),u}(),jr=function(){function u(a){var r=this;Q(this,u),p(this,"_emitOnLoaded",function(l,o){var h=l.response,c=l.options,v=c||{},f=v.firstByteTime,d=v.startTime,S=v.endTime,m=v.contentLength,g=S-d;r.hls.emit(x.SPEED,{time:g,byteLength:m,url:o}),r.hls.emit(x.LOAD_COMPLETE,{url:o,elapsed:g||0}),r.hls.emit(x.TTFB,{url:o,responseUrl:h.url,elapsed:f-d}),r.hls.emit(x.LOAD_RESPONSE_HEADERS,{headers:h.headers,url:o})}),p(this,"_onLoaderRetry",function(l,o){r.hls.emit(G.LOAD_RETRY,{error:J.network(l),retryTime:o})}),this.hls=a,this._timer=null,this._useLowLatency=a.config.useLowLatency;var e=this.hls.config,t=e.retryCount,i=e.retryDelay,n=e.manifestLoadTimeout,s=e.fetchOptions;this._loader=new ge(Y(Y({},s),{},{responseType:"text",retry:t,retryDelay:i,timeout:n,onRetryError:this._onLoaderRetry})),this._audioLoader=new ge(Y(Y({},s),{},{responseType:"text",retry:t,retryDelay:i,timeout:n,onRetryError:this._onLoaderRetry})),this._subtitleLoader=new ge(Y(Y({},s),{},{responseType:"text",retry:t,retryDelay:i,timeout:n,onRetryError:this._onLoaderRetry}))}return $(u,[{key:"load",value:function(){var a=H(A().mark(function e(t,i,n){var s,l,o,h,c,v,f,d,S,m,g,D,b,E,k,O,P,R,M,F;return A().wrap(function(y){for(;;)switch(y.prev=y.next){case 0:return s=[this._loader.load(t)],i&&s.push(this._audioLoader.load(i)),n&&s.push(this._subtitleLoader.load(n)),y.prev=3,y.next=6,Promise.all(s);case 6:if(d=y.sent,S=ue(d,3),m=S[0],g=S[1],D=S[2],m){y.next=13;break}return y.abrupt("return",[]);case 13:this._emitOnLoaded(m,t),l=m.data,c=m.response.url||t,i?(o=g==null?void 0:g.data,h=D==null?void 0:D.data,v=(g==null||(b=g.response)===null||b===void 0?void 0:b.url)||i,f=(D==null||(E=D.response)===null||E===void 0?void 0:E.url)||n,o&&this._emitOnLoaded(g,i),h&&this._emitOnLoaded(D,n)):(h=g==null?void 0:g.data,f=(g==null||(k=g.response)===null||k===void 0?void 0:k.url)||n,h&&this._emitOnLoaded(g,n)),y.next=22;break;case 19:throw y.prev=19,y.t0=y.catch(3),J.network(y.t0);case 22:if(O=this.hls.config.onPreM3U8Parse,y.prev=23,O&&(l=O(l)||l,o&&(o=O(o,!0)||o),h&&(h=O(h,!0)||h)),P=Ae.parse(l,c,this._useLowLatency),!(((F=P)===null||F===void 0?void 0:F.live)===!1&&P.segments&&!P.segments.length)){y.next=28;break}throw new Error("empty segments list");case 28:o&&(R=Ae.parse(o,v,this._useLowLatency)),h&&(M=Ae.parse(h,f,this._useLowLatency)),y.next=35;break;case 32:throw y.prev=32,y.t1=y.catch(23),new J(ie.MANIFEST,ie.SUB_TYPES.HLS,y.t1);case 35:return P&&(P.isMaster?this.hls.emit(G.HLS_MANIFEST_LOADED,{playlist:P}):(this._useLowLatency&&(P.canBlockReload?this.deliveryDirectives=new Br(P.nextSN,P.nextIndex,""):this.deliveryDirectives=null),this.hls.emit(G.HLS_LEVEL_LOADED,{playlist:P}))),y.abrupt("return",[P,R,M]);case 37:case"end":return y.stop()}},e,this,[[3,19],[23,32]])}));function r(e,t,i){return a.apply(this,arguments)}return r}()},{key:"parseText",value:function(r,e){var t=this.hls.config.onPreM3U8Parse,i;try{var n;if(t&&(r=t(r)||r),i=Ae.parse(r,e,this._useLowLatency),((n=i)===null||n===void 0?void 0:n.live)===!1&&i.segments&&!i.segments.length)throw new Error("empty segments list")}catch(s){throw new J(ie.MANIFEST,ie.SUB_TYPES.HLS,s)}return i&&(i.isMaster?this.hls.emit(G.HLS_MANIFEST_LOADED,{playlist:i}):this.hls.emit(G.HLS_LEVEL_LOADED,{playlist:i})),[i]}},{key:"poll",value:function(r,e,t,i,n,s){var l=this;clearTimeout(this._timer),s=s||3e3;var o=this.hls.config.pollRetryCount,h=function(){var c=H(A().mark(function v(){var f,d;return A().wrap(function(m){for(;;)switch(m.prev=m.next){case 0:return clearTimeout(l._timer),f=r,m.prev=2,l.deliveryDirectives&&(f=l.deliveryDirectives.addDirectives(r)),m.next=6,l.load(f,e,t);case 6:if(d=m.sent,d[0]){m.next=9;break}return m.abrupt("return");case 9:o=l.hls.config.pollRetryCount,i(d[0],d[1],d[2]),m.next=17;break;case 13:m.prev=13,m.t0=m.catch(2),o--,o<=0&&n(m.t0);case 17:l._timer=setTimeout(h,s);case 18:case"end":return m.stop()}},v,null,[[2,13]])}));return function(){return c.apply(this,arguments)}}();this._timer=setTimeout(h,s)}},{key:"stopPoll",value:function(){return clearTimeout(this._timer),this.cancel()}},{key:"cancel",value:function(){return Promise.all([this._loader.cancel(),this._audioLoader.cancel()])}}]),u}();function Ot(u,a,r){return a>r&&(r=a),Math.min(Math.max(u,a),r)}var et=new ye("playlist"),kt=function(){function u(a,r,e){Q(this,u),p(this,"live",void 0),p(this,"id",0),p(this,"bitrate",0),p(this,"width",0),p(this,"height",0),p(this,"name",""),p(this,"url",""),p(this,"audioCodec",""),p(this,"videoCodec",""),p(this,"textCodec",""),p(this,"startCC",0),p(this,"endCC",0),p(this,"startSN",0),p(this,"endSN",-1),p(this,"totalDuration",0),p(this,"targetDuration",0),p(this,"partTargetDuration",0),p(this,"canSkipUntil",0),p(this,"canSkipDateRanges",!1),p(this,"skippedSegments",0),p(this,"canBlockReload",!1),p(this,"partHoldBack",0),p(this,"lowLatency",!1),p(this,"endPartIndex",0),p(this,"snDiff",null),p(this,"segments",[]),p(this,"audioStreams",[]),p(this,"subtitleStreams",[]),p(this,"closedCaptions",[]),p(this,"currentAudioStream",null),p(this,"currentSubtitleStream",null),this.update(this._setLLPlaybackPoint(a),r,e)}return $(u,[{key:"lastSegment",get:function(){return this.segments.length?this.segments[this.segments.length-1]:null}},{key:"segmentDuration",get:function(){var r;return this.targetDuration||((r=this.segments[0])===null||r===void 0?void 0:r.duration)||0}},{key:"liveEdge",get:function(){return this.endTime},set:function(r){this.endTime=r}},{key:"endTime",get:function(){var r;return((r=this.lastSegment)===null||r===void 0?void 0:r.end)||0},set:function(r){var e=this.lastSegment;e&&(e.duration=r-e.start)}},{key:"currentSubtitleEndSn",get:function(){var r;return((r=this.currentSubtitleStream)===null||r===void 0?void 0:r.endSN)||0}},{key:"clearOldSegment",value:function(r,e){return this.currentAudioStream&&this._clearSegments(r,e),this._clearSegments(r,e)}},{key:"getAudioSegment",value:function(r){if(!(!r||!this.currentAudioStream)){var e=r.sn-this.snDiff;return this.currentAudioStream.segments.find(function(t){return t.sn===e})}}},{key:"update",value:function(r,e){this.url=r.url,Array.isArray(r.segments)?((this.live===null||this.live===void 0)&&(this.live=r.live),this._updateSegments(r,this),this.startCC=r.startCC,this.endCC=r.endCC,this.startSN=r.startSN,this.endSN=r.endSN||-1,this.totalDuration=r.totalDuration,this.targetDuration=r.targetDuration,this.live=r.live,this.lowLatency=r.lowLatency,this.canBlockReload=r.canBlockReload,this.canSkipDateRanges=r.canSkipDateRanges,this.canSkipUntil=r.canSkipUntil,this.partHoldBack=r.partHoldBack,this.partTargetDuration=r.partTargetDuration,this.skippedSegments=r.skippedSegments,this.endPartIndex=r.endPartIndex,e&&this.currentAudioStream&&Array.isArray(e.segments)&&(this._updateSegments(e,this.currentAudioStream),(this.snDiff===null||this.snDiff===void 0)&&r.segments.length&&e.segments.length&&(this.snDiff=r.segments[0].sn-e.segments[0].sn))):(this.id=r.id,this.bitrate=r.bitrate,this.width=r.width,this.height=r.height,this.name=r.name,this.audioCodec=r.audioCodec,this.videoCodec=r.videoCodec,this.textCodec=r.textCodec,this.audioStreams=r.audioStreams,this.subtitleStreams=r.subtitleStreams,!this.currentAudioStream&&this.audioStreams.length&&(this.currentAudioStream=this.audioStreams.find(function(t){return t.default})||this.audioStreams[0]),!this.currentSubtitleStream&&this.subtitleStreams.length&&(this.currentSubtitleStream=this.subtitleStreams.find(function(t){return t.default})||this.subtitleStreams[0]))}},{key:"updateSubtitle",value:function(r){var e=this;if(r&&this.currentSubtitleStream&&Array.isArray(r.segments)){var t=this._updateSegments(r,this.currentSubtitleStream),i=this.currentSubtitleStream.segments;if(i.length>100&&(this.currentSubtitleStream.segments=i.slice(100)),!!t)return t.map(function(n){return{sn:n.sn,url:n.url,duration:n.duration,start:n.start,end:n.end,lang:e.currentSubtitleStream.lang}})}}},{key:"switchSubtitle",value:function(r){var e=this.subtitleStreams.find(function(i){return i.lang===r}),t=this.currentSubtitleStream;e&&(this.currentSubtitleStream=e,t.segments=[])}},{key:"_setLLPlaybackPoint",value:function(r){if(!r.lowLatency||!r.segments.length)return r;for(var e=r.totalDuration-r.partHoldBack,t=r.segments,i=0,n=0,s=t.length;n<s;n++)t[n].start<=e&&t[n].independent&&(i=n);var l=t.slice(i),o=0;return l.forEach(function(h){h.start=o,o=h.end}),r.segments=l,r.totalDuration=o,r.startSN=l[0].sn,r.startCC=l[0].cc,et.log("set ll-hls playback point: SN=".concat(r.startSN," partIndex=").concat(l[0].partIndex,", duration=").concat(o)),r}},{key:"_clearSegments",value:function(r,e){for(var t=0,i=this.segments,n=0,s=i.length;n<s;n++)if(i[n].end>=r){t=n;break}return t>e&&(t=e),t&&(this.segments=this.segments.slice(t),this.currentAudioStream&&(this.currentAudioStream.segments=this.currentAudioStream.segments.slice(t))),e-t}},{key:"_updateSegments",value:function(r,e){var t=e.segments;if(this.live){var i,n=r.lowLatency,s=t[t.length-1],l=(i=s==null?void 0:s.sn)!==null&&i!==void 0?i:-1,o=(s==null?void 0:s.partIndex)||0,h=l<r.endSN&&r.segments.length;if(n&&(h=h||o<r.endPartIndex),h){et.log("update segments: endSN:".concat(l,", partIndex:").concat(o," --> endSN:").concat(r.endSN,", partIndex:").concat(r.endPartIndex));var c=r.segments.findIndex(function(m){return m.sn===l&&m.partIndex===o}),v=c<0?r.segments:r.segments.slice(c+1);if(t.length&&v.length){var f=s.end,d=f;v.forEach(function(m){m.start=f,f=m.end}),et.log("liveEdge: ".concat(d," -> ").concat(f));var S=(s==null?void 0:s.cc)||-1;S>v[0].cc&&v.forEach(function(m){return m.cc+=S})}return e.endSN=r.endSN,e.segments=t.concat(v),v}}else e.segments=r.segments}}]),u}(),Kr=function(){function u(a){Q(this,u),p(this,"streams",[]),p(this,"currentStream",null),p(this,"dvrWindow",0),p(this,"_segmentPointer",-1),this.hls=a}return $(u,[{key:"lowLatency",get:function(){var r;return(r=this.currentStream)===null||r===void 0?void 0:r.lowLatency}},{key:"lastSegment",get:function(){var r;return(r=this.currentStream)===null||r===void 0?void 0:r.lastSegment}},{key:"currentSegment",get:function(){var r;return(r=this.currentSegments)===null||r===void 0?void 0:r[this._segmentPointer]}},{key:"nextSegment",get:function(){var r;return(r=this.currentSegments)===null||r===void 0?void 0:r[this._segmentPointer+1]}},{key:"currentSegments",get:function(){var r;return(r=this.currentStream)===null||r===void 0?void 0:r.segments}},{key:"currentSubtitleEndSn",get:function(){var r;return(r=this.currentStream)===null||r===void 0?void 0:r.currentSubtitleEndSn}},{key:"liveEdge",get:function(){var r;return(r=this.currentStream)===null||r===void 0?void 0:r.liveEdge},set:function(r){this.currentStream&&(this.currentStream.liveEdge=r)}},{key:"totalDuration",get:function(){var r;return((r=this.currentStream)===null||r===void 0?void 0:r.totalDuration)||0}},{key:"seekRange",get:function(){var r=this.currentSegments;if(!(!r||!r.length))return[r[0].start,r[r.length-1].end]}},{key:"nbSegments",get:function(){var r;return((r=this.currentSegments)===null||r===void 0?void 0:r.length)||0}},{key:"isEmpty",get:function(){var r;return!((r=this.currentSegments)!==null&&r!==void 0&&r.length)}},{key:"isLive",get:function(){var r;return(r=this.currentStream)===null||r===void 0?void 0:r.live}},{key:"hadSegmentLoaded",get:function(){return this._segmentPointer!==-1}},{key:"hasSubtitle",get:function(){var r;return!!((r=this.currentStream)!==null&&r!==void 0&&r.currentSubtitleStream)}},{key:"getAudioSegment",value:function(r){var e;return(e=this.currentStream)===null||e===void 0?void 0:e.getAudioSegment(r)}},{key:"moveSegmentPointer",value:function(r){var e;r==null&&(r=this._segmentPointer+1),this._segmentPointer=Ot(r,-1,(e=this.currentSegments)===null||e===void 0?void 0:e.length)}},{key:"reset",value:function(){this.streams=[],this.currentStream=null,this.dvrWindow=0,this._segmentPointer=-1}},{key:"getSegmentByIndex",value:function(r){var e;return(e=this.currentSegments)===null||e===void 0?void 0:e[r]}},{key:"setNextSegmentByIndex",value:function(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;this._segmentPointer=r-1}},{key:"setNextSegmentBySN",value:function(){var r,e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,t=(r=this.currentSegments)===null||r===void 0?void 0:r.findIndex(function(i){return i.sn===e});return t!==-1&&this.setNextSegmentByIndex(t+1),t}},{key:"findSegmentIndexByTime",value:function(r){var e=this.currentSegments;if(e){for(var t=0,i=e.length,n;t<i;t++)if(n=e[t],r>=n.start&&r<n.end)return t;var s=e[e.length-1];if(Math.abs(r-(s==null?void 0:s.end))<.2)return e.length-1}}},{key:"upsertPlaylist",value:function(r,e,t){var i=this;if(r){if(r.isMaster)this.streams.length=r.streams.length,r.streams.filter(function(o){return o.url}).forEach(function(o,h){i.streams[h]?i.streams[h].update(o):i.streams[h]=new kt(o)}),this.currentStream=this.streams[0];else if(Array.isArray(r.segments)){var n=this.currentStream;if(n){n.update(r,e,t);var s=n.updateSubtitle(t);s&&this.hls.emit(G.SUBTITLE_SEGMENTS,{list:s})}else this.reset(),this.currentStream=this.streams[0]=new kt(r,e,t)}var l=this.currentStream;l&&this.hls.isLive&&!this.dvrWindow&&(this.dvrWindow=this.currentSegments.reduce(function(o,h){return o+=h.duration,o},0))}}},{key:"updateSegmentsRanges",value:function(r,e){var t,i=(t=this.currentSegments)===null||t===void 0?void 0:t.filter(function(n){return n.sn>=r});i.forEach(function(n){n.start=e,e=n.end})}},{key:"switchSubtitle",value:function(r){var e;(e=this.currentStream)===null||e===void 0||e.switchSubtitle(r)}},{key:"clearOldSegment",value:function(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.hls.config.maxPlaylistSize||50,e=this.currentStream;if(!(!this.dvrWindow||!e)){var t=e.endTime-this.dvrWindow;if(!(t<=0)){var i=e.segments;i.length<=r||(this._segmentPointer=e.clearOldSegment(t,this._segmentPointer))}}}},{key:"checkSegmentTrackChange",value:function(r,e){var t=this.findSegmentIndexByTime(r),i=this.getSegmentByIndex(t);if(i&&!(!i.hasAudio&&!i.hasVideo)){if(e!==2&&i.hasAudio&&i.hasVideo)return i;if(!(i.end-r>.3)){var n=this.getSegmentByIndex(t+1);if(n&&!(!n.hasAudio&&!n.hasVideo)&&(n.hasAudio!==i.hasAudio||n.hasVideo!==i.hasVideo))return n}}}},{key:"feedbackLiveEdge",value:function(r,e){var t,i=this.currentSegments;if(i){var n=((t=this.lastSegment)===null||t===void 0?void 0:t.sn)===r.sn;if(n){this.liveEdge=e;return}this.updateSegmentsRanges(r.sn+1,e)}}}]),u}(),Xr=function(){function u(a){var r=this;Q(this,u),p(this,"error",null),p(this,"_emitOnLoaded",function(l,o){var h=l.data,c=l.response,v=l.options,f=v||{},d=f.firstByteTime,S=f.startTime,m=f.endTime,g=f.contentLength,D=m-S;r._bandwidthService.addRecord(g||h.byteLength,D),r.hls.emit(x.SPEED,{time:D,byteLength:g,url:o}),r.hls.emit(x.LOAD_COMPLETE,{url:o,elapsed:D||0}),r.hls.emit(x.TTFB,{url:o,responseUrl:c.url,elapsed:d-S}),r.hls.emit(x.LOAD_RESPONSE_HEADERS,{headers:c.headers,url:o})}),p(this,"_onLoaderRetry",function(l,o){r.hls.emit(x.LOAD_RETRY,{error:J.network(l),retryTime:o})}),this.hls=a,this._bandwidthService=new Qt,this._mapCache={},this._keyCache={};var e=this.hls.config,t=e.retryCount,i=e.retryDelay,n=e.loadTimeout,s=e.fetchOptions;this._segmentLoader=new ge(Y(Y({},s),{},{responseType:"arraybuffer",retry:t,retryDelay:i,timeout:n,onRetryError:this._onLoaderRetry})),this._audioSegmentLoader=new ge(Y(Y({},s),{},{responseType:"arraybuffer",retry:t,retryDelay:i,timeout:n,onRetryError:this._onLoaderRetry})),this._keyLoader=new ge(Y(Y({},s),{},{responseType:"arraybuffer",retry:t,retryDelay:i,timeout:n,onRetryError:this._onLoaderRetry}))}return $(u,[{key:"speedInfo",value:function(){return{speed:this._bandwidthService.getLatestSpeed(),avgSpeed:this._bandwidthService.getAvgSpeed()}}},{key:"load",value:function(r,e,t){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:t,n=[];return r&&(n[0]=this.loadVideoSegment(r,t)),e&&(n[1]=this.loadAudioSegment(e,i)),Promise.all(n)}},{key:"loadVideoSegment",value:function(r,e){return this._loadSegment(this._segmentLoader,r,e)}},{key:"loadAudioSegment",value:function(r,e){return this._loadSegment(this._audioSegmentLoader,r,e)}},{key:"_loadSegment",value:function(){var a=H(A().mark(function e(t,i,n){var s=this,l,o,h,c,v,f,d,S,m,g,D,b,E,k,O;return A().wrap(function(R){for(;;)switch(R.prev=R.next){case 0:return d=[],this.hls.emit(x.LOAD_START,{url:i.url}),d[0]=t.load(i.url),n&&i.initSegment&&(m=i.initSegment.url,o=this._mapCache[m],o||(this.hls.emit(x.LOAD_START,{url:m}),d[1]=t.load(m).then(function(M){if(M){var F=Object.keys(s._mapCache);F>30&&(s._mapCache={}),o=s._mapCache[m]=M.data,s._emitOnLoaded(M,m)}})),g=(S=i.initSegment.key)===null||S===void 0?void 0:S.url,g&&(f=i.initSegment.key.iv,v=this._keyCache[g],v||(this.hls.emit(x.LOAD_START,{url:g}),d[2]=this._keyLoader.load(g).then(function(M){M&&(v=s._keyCache[g]=M.data,s._emitOnLoaded(M,g))})))),D=(l=i.key)===null||l===void 0?void 0:l.url,D&&i.key.isSegmentEncrypted()&&(c=i.key.iv,h=this._keyCache[D],h||(this.hls.emit(x.LOAD_START,{url:D}),d[3]=this._keyLoader.load(D).then(function(M){M&&(h=s._keyCache[D]=M.data,s._emitOnLoaded(M,D))}))),R.next=8,Promise.all(d);case 8:if(b=R.sent,E=ue(b,1),k=E[0],k){R.next=13;break}return R.abrupt("return");case 13:return O=k.data,this._emitOnLoaded(k,i.url),R.abrupt("return",{data:O,map:o,key:h,mapKey:v,keyIv:c,mapKeyIv:f});case 16:case"end":return R.stop()}},e,this)}));function r(e,t,i){return a.apply(this,arguments)}return r}()},{key:"reset",value:function(){this.error=null,this._mapCache={},this._keyCache={},this._bandwidthService.reset()}},{key:"cancel",value:function(){var a=H(A().mark(function e(){return A().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,Promise.all([this._keyLoader.cancel(),this._segmentLoader.cancel(),this._audioSegmentLoader.cancel()]);case 2:case"end":return i.stop()}},e,this)}));function r(){return a.apply(this,arguments)}return r}()}]),u}(),Z=new ye("hls"),Se=function(u){Oe(r,u);var a=Me(r);function r(e){var t;return Q(this,r),t=a.call(this),p(N(t),"version",r.version),p(N(t),"media",null),p(N(t),"config",null),p(N(t),"_manifestLoader",null),p(N(t),"_segmentLoader",null),p(N(t),"_playlist",null),p(N(t),"_bufferService",null),p(N(t),"_gapService",null),p(N(t),"_seiService",null),p(N(t),"_stats",null),p(N(t),"_prevSegSn",null),p(N(t),"_prevSegCc",null),p(N(t),"_tickTimer",null),p(N(t),"_tickInterval",500),p(N(t),"_segmentProcessing",!1),p(N(t),"_reloadOnPlay",!1),p(N(t),"_switchUrlOpts",null),p(N(t),"_isProcessQuotaExceeded",!1),p(N(t),"_loadSegment",H(A().mark(function i(){var n,s,l,o,h,c,v,f,d;return A().wrap(function(m){for(;;)switch(m.prev=m.next){case 0:if(!(t._segmentProcessing||!t.media)){m.next=2;break}return m.abrupt("return");case 2:if(n=t._playlist,s=n.nextSegment,l=n.lastSegment,o=N(t),h=o.config,c=.016,v=Math.min(Math.max((l==null?void 0:l.duration)-c/2||0,c),.1),s){m.next=8;break}return m.abrupt("return");case 8:if(t.isLive){m.next=18;break}if(f=t.bufferInfo(),t.media.paused&&!t.media.currentTime&&(f=t.bufferInfo(f.nextStart||.5)),d=Math.abs(f.end-t.media.duration)<v,!(f.remaining>=h.preloadTime||d)){m.next=15;break}return t._tryEos(),m.abrupt("return");case 15:if(!(h.preferMMSStreaming&&!t._bufferService.msStreaming)){m.next=17;break}return m.abrupt("return");case 17:!t._urlSwitching&&t._prevSegSn!==s.sn-1&&f.end&&Math.abs(s.start-f.end)>1&&t._playlist.setNextSegmentByIndex(t._playlist.findSegmentIndexByTime(f.end+.1));case 18:return m.abrupt("return",t._loadSegmentDirect());case 19:case"end":return m.stop()}},i)}))),p(N(t),"_onLoadeddata",function(){t.isLive&&!t.config.mseLowLatency&&t.media.duration!==1/0&&t._bufferService.updateDuration(1/0).catch(function(i){})}),p(N(t),"_onPlay",H(A().mark(function i(){return A().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(!(t.media.seeking&&t.media.currentTime===0)){s.next=3;break}return Z.debug("replay currentTime 0, return"),s.abrupt("return");case 3:if(clearTimeout(t._disconnectTimer),!t._reloadOnPlay){s.next=9;break}t._reloadOnPlay=!1,t.replay(!0),s.next=12;break;case 9:return s.next=11,t._loadSegment();case 11:t._startTick();case 12:case"end":return s.stop()}},i)}))),p(N(t),"_onPause",function(){if(t.isLive){if(!t._reloadOnPlay){var i=t.config.disconnectTime;if(i==null&&(i=t._playlist.dvrWindow),!Number.isFinite(i))return;clearTimeout(t._disconnectTimer),t._disconnectTimer=setTimeout(function(){t._reloadOnPlay=!0,t._clear()},i||0)}}else t._stopTick()}),p(N(t),"_onSeeking",H(A().mark(function i(){var n,s,l,o,h,c,v;return A().wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(t.media){d.next=2;break}return d.abrupt("return");case 2:if(t._onCheckQuotaExceeded(),n=t.media.currentTime,s=t._playlist.seekRange,!s){d.next=10;break}if(l=Ot(n,s[0],t.isLive?s[1]:t.media.duration),!(l>=0&&Math.abs(n-l)>=.1)){d.next=10;break}return t.media.currentTime=l,d.abrupt("return");case 10:if(o=t._playlist.currentSegment,h=fe.info(fe.get(t.media),n,.1),!o){d.next=17;break}if(!(h.end&&Math.abs(h.end-o.end)<.2)){d.next=15;break}return d.abrupt("return");case 15:if(!(t.isLive&&h.end)){d.next=17;break}return d.abrupt("return");case 17:if(c=t._playlist.findSegmentIndexByTime(n),v=t._playlist.getSegmentByIndex(c),!(c==null||!v||t._segmentProcessing&&v===t._playlist.nextSegment)){d.next=21;break}return d.abrupt("return");case 21:return Z.debug("seek to",n,v),t._playlist.setNextSegmentByIndex(c),t._stopTick(),d.next=26,t._segmentLoader.cancel();case 26:if(t._segmentProcessing=!1,!(!h.end||t.isLive)){d.next=30;break}return d.next=30,t._loadSegmentDirect(!0);case 30:t._startTick();case 31:case"end":return d.stop()}},i)}))),p(N(t),"_onTimeupdate",function(){if(t.media){var i=t.config;if(i.isLive&&i.maxLatency&&i.targetLatency){var n=t._playlist.liveEdge;if(!n)return;var s=n-t.media.currentTime;s>=i.maxLatency&&(Z.debug("latency jump, currentTime:".concat(t.media.currentTime,", liveEdge:").concat(n,",  latency=").concat(s)),t.media.currentTime=n-i.targetLatency)}if(i.seiInTime){var l;(l=t._seiService)===null||l===void 0||l.throw(t.media.currentTime)}i.allowedStreamTrackChange&&!i.softDecode&&t.media.readyState&&t._checkStreamTrackChange(t.media.currentTime)}}),p(N(t),"_tick",function(){if(t.media){t._startTick();var i=t.media,n=t._segmentLoader.error;if(t._onCheckQuotaExceeded(),t._isProcessQuotaExceeded&&(t._bufferService.isFull()||(t._isProcessQuotaExceeded=!1,t._segmentProcessing=!1)),n){var s=.5;(!i.readyState||t.bufferInfo(s).remaining<1)&&(n.fatal=!0,t._emitError(J.network(n)));return}i.readyState&&($t(i)?(t._loadSegment(),t._gapService&&t._gapService.do(i,t.config.maxJumpDistance,t.isLive)):i.readyState<2&&t._gapService&&t._gapService.do(i,t.config.maxJumpDistance,i.currentTime?t.isLive:!0)),t.isLive||t._tryEos()}}),t.config=e=Ar(e),t.media=t.config.media,t._manifestLoader=new jr(N(t)),t._segmentLoader=new Xr(N(t)),t._playlist=new Kr(N(t)),t._bufferService=new Lr(N(t)),e.seiInTime&&(t._seiService=new Jt(N(t))),e.softDecode||(t._gapService=new Zt),t._stats=new er(N(t),9e4),t.media.addEventListener("loadeddata",t._onLoadeddata),t.media.addEventListener("play",t._onPlay),t.media.addEventListener("pause",t._onPause),t.media.addEventListener("seeking",t._onSeeking),t.media.addEventListener("timeupdate",t._onTimeupdate),t}return $(r,[{key:"isLive",get:function(){return this._playlist.isLive}},{key:"streams",get:function(){return this._playlist.streams}},{key:"currentStream",get:function(){return this._playlist.currentStream}},{key:"hasSubtitle",get:function(){return this._playlist.hasSubtitle}},{key:"totalDuration",get:function(){return this._playlist.totalDuration}},{key:"baseDts",get:function(){var t;return(t=this._bufferService)===null||t===void 0?void 0:t.baseDts}},{key:"abrSwitchPoint",get:function(){var t=this._urlSwitching?this._playlist.currentSegment:this._playlist.nextSegment;return t?t.start+t.duration/2:null}},{key:"speedInfo",value:function(){return this._segmentLoader.speedInfo()}},{key:"bufferInfo",value:function(){var t,i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:.1;return fe.info(fe.get(this.media),(t=this.media)===null||t===void 0?void 0:t.currentTime,i)}},{key:"getStats",value:function(){return this._stats.getStats()}},{key:"playbackQuality",value:function(){return tr(this.media)}},{key:"load",value:function(){var e=H(A().mark(function i(){var n,s,l,o=arguments;return A().wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return n=o.length>0&&o[0]!==void 0?o[0]:"",s=o.length>1&&o[1]!==void 0?o[1]:{},l=typeof s=="boolean"?s:!!(s!=null&&s.reuseMse),ke(s)==="object"&&s!==null&&s!==void 0&&s.clearSwitchStatus&&(this._urlSwitching=!1,this._switchUrlOpts=null,this.config.startTime=void 0),n&&(this.config.url=n),n=this.config.url,c.next=8,this._reset(l);case 8:return c.next=10,this._loadData(n);case 10:this._startTick();case 11:case"end":return c.stop()}},i,this)}));function t(){return e.apply(this,arguments)}return t}()},{key:"_loadData",value:function(){var e=H(A().mark(function i(n){var s,l,o,h,c,v,f,d,S,m,g,D,b;return A().wrap(function(k){for(;;)switch(k.prev=k.next){case 0:try{n&&(n=n.trim())}catch{}if(n){k.next=3;break}throw this._emitError(new J(ie.OTHER,ie.SUB_TYPES.OPTION,null,null,"m3u8 url is missing"));case 3:return k.next=5,this._loadM3U8(n);case 5:if(s=k.sent,l=this._playlist.currentStream,!this._urlSwitching){k.next=23;break}if(!this.isLive){k.next=14;break}o=this._playlist.setNextSegmentBySN(this._prevSegSn),Z.log("segment nb=".concat(this._prevSegSn," index of ").concat(o," in the new playlist")),o===-1&&(this._prevSegCc=null,this._prevSegSn=null),k.next=23;break;case 14:if(l.bitrate===0&&(h=this._switchUrlOpts)!==null&&h!==void 0&&h.bitrate&&(l.bitrate=(f=this._switchUrlOpts)===null||f===void 0?void 0:f.bitrate),d=typeof((c=this._switchUrlOpts)===null||c===void 0?void 0:c.startTime)=="number"?(v=this._switchUrlOpts)===null||v===void 0?void 0:v.startTime:this._getSeamlessSwitchPoint(),this.config.startTime=d,S=this._playlist.findSegmentIndexByTime(d),m=this._playlist.getSegmentByIndex(S+1),!m){k.next=23;break}return g=m.start,k.next=23,this._bufferService.removeBuffer(g);case 23:if(s){k.next=25;break}return k.abrupt("return");case 25:if(!this.isLive){k.next=36;break}if(this._bufferService.setLiveSeekableRange(0,4294967295),Z.log("totalDuration first time got:",this._playlist.totalDuration),Z.log("nb segments got:",this._playlist.nbSegments),this.config.targetLatency<this._playlist.totalDuration&&(this.config.targetLatency=this._playlist.totalDuration,this.config.maxLatency=1.5*this.config.targetLatency),s.isMaster||this._pollM3U8(n),!(this._playlist.nbSegments<this.config.minSegmentsStartPlay)){k.next=33;break}return k.abrupt("return");case 33:return k.next=35,this._loadSegment();case 35:return k.abrupt("return");case 36:return k.next=38,this._bufferService.updateDuration(l.totalDuration);case 38:return D=this.config.startTime,D&&((b=this._switchUrlOpts)!==null&&b!==void 0&&b.seamless||(this.media.currentTime=D),this._playlist.setNextSegmentByIndex(this._playlist.findSegmentIndexByTime(D)||0)),k.next=42,this._loadSegment();case 42:case"end":return k.stop()}},i,this)}));function t(i){return e.apply(this,arguments)}return t}()},{key:"replay",value:function(){var e=H(A().mark(function i(n){return A().wrap(function(l){for(;;)switch(l.prev=l.next){case 0:return this.config.startTime=0,this._urlSwitching=!1,this._switchUrlOpts=null,l.next=5,this.load();case 5:return this._reloadOnPlay=!1,l.abrupt("return",this.media.play(!n));case 7:case"end":return l.stop()}},i,this)}));function t(i){return e.apply(this,arguments)}return t}()},{key:"switchURL",value:function(){var e=H(A().mark(function i(n){var s,l,o,h,c,v,f,d=arguments;return A().wrap(function(m){for(;;)switch(m.prev=m.next){case 0:s=d.length>1&&d[1]!==void 0?d[1]:{},l={seamless:!1,startTime:0,bitrate:0},m.t0=ke(s),m.next=m.t0==="number"?5:m.t0==="boolean"?7:m.t0==="object"?9:11;break;case 5:return s={startTime:s},m.abrupt("break",12);case 7:return s={seamless:s},m.abrupt("break",12);case 9:for(o in s)(s[o]===void 0||s[o]===null)&&delete s[o];return m.abrupt("break",12);case 11:throw"unsupported switchURL args: ".concat(s);case 12:if(s=Object.assign({},l,s),h=s,c=h.seamless,v=h.startTime,this.config.url=n,this.config.startTime=v,this._switchUrlOpts=s,c){m.next=38;break}if(m.prev=18,!this.config.softDecode){m.next=23;break}m.t1=this.load(n),m.next=26;break;case 23:return m.next=25,this.load(n);case 25:m.t1=m.sent;case 26:f=m.t1,m.next=33;break;case 29:throw m.prev=29,m.t2=m.catch(18),this.emit(G.SWITCH_URL_FAILED,m.t2),m.t2;case 33:return this._reloadOnPlay=!1,f&&this.emit(G.SWITCH_URL_SUCCESS,{url:n}),m.abrupt("return",this.media.play(!0));case 38:return this._urlSwitching=!0,this.isLive||(this._prevSegSn=null,this._prevSegCc=null),this._playlist.reset(),this._bufferService.seamlessSwitch(),m.next=44,this._clear();case 44:return m.next=46,this._loadData(n);case 46:this._startTick();case 47:this._switchUrlOpts=null;case 48:case"end":return m.stop()}},i,this,[[18,29]])}));function t(i){return e.apply(this,arguments)}return t}()},{key:"switchStream",value:function(){var e=H(A().mark(function i(n){var s,l,o,h,c,v=arguments;return A().wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(s=v.length>1&&v[1]!==void 0?v[1]:!0,l=this.currentStream,o=this.streams,!(!l||l.id===n||!o||o.length<2)){d.next=5;break}return d.abrupt("return");case 5:if(h=o.find(function(S){return S.id===n}),h){d.next=8;break}return d.abrupt("return");case 8:return d.prev=8,d.next=11,this._clear();case 11:if(!s){d.next=14;break}return d.next=14,this._bufferService.clearAllBuffer();case 14:d.next=19;break;case 16:throw d.prev=16,d.t0=d.catch(8),this._emitError(J.create(d.t0));case 19:if(l.currentAudioStream&&h.audioStreams.length>2&&(c=l.currentAudioStream.id,h.currentAudioStream=h.audioStreams.find(function(S){return S.id===c})||h.currentAudioStream),this._playlist.currentStream=h,d.prev=21,!(this.isLive||!h.segments.length)){d.next=25;break}return d.next=25,this._refreshM3U8();case 25:return this._playlist.setNextSegmentByIndex(this._playlist.findSegmentIndexByTime(this.media.currentTime)||0),this._prevSegCc=null,d.next=29,this._loadSegmentDirect();case 29:d.next=35;break;case 31:throw d.prev=31,d.t1=d.catch(21),this._playlist.currentStream=l,d.t1;case 35:return this._startTick(),d.abrupt("return",h);case 37:case"end":return d.stop()}},i,this,[[8,16],[21,31]])}));function t(i){return e.apply(this,arguments)}return t}()},{key:"switchAudioStream",value:function(){var e=H(A().mark(function i(n){var s,l,o,h,c=arguments;return A().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(s=c.length>1&&c[1]!==void 0?c[1]:!0,l=this.currentStream,l){f.next=4;break}return f.abrupt("return");case 4:if(o=l.currentAudioStream,!(!o||o.id===n||l.audioStreams.length<2)){f.next=7;break}return f.abrupt("return");case 7:if(h=l.audioStreams.find(function(d){return d.id===n}),h){f.next=10;break}return f.abrupt("return");case 10:return f.prev=10,f.next=13,this._clear();case 13:if(!s){f.next=16;break}return f.next=16,this._bufferService.clearAllBuffer();case 16:f.next=21;break;case 18:throw f.prev=18,f.t0=f.catch(10),this._emitError(J.create(f.t0));case 21:if(l.currentAudioStream=h,f.prev=22,!(this.isLive||!h.segments.length)){f.next=26;break}return f.next=26,this._refreshM3U8();case 26:return this._playlist.setNextSegmentByIndex(this._playlist.findSegmentIndexByTime(this.media.currentTime)||0),this._prevSegCc=null,f.next=30,this._loadSegmentDirect();case 30:f.next=36;break;case 32:throw f.prev=32,f.t1=f.catch(22),l.currentAudioStream=o,f.t1;case 36:return this._startTick(),f.abrupt("return",h);case 38:case"end":return f.stop()}},i,this,[[10,18],[22,32]])}));function t(i){return e.apply(this,arguments)}return t}()},{key:"switchSubtitleStream",value:function(){var e=H(A().mark(function i(n){return A().wrap(function(l){for(;;)switch(l.prev=l.next){case 0:return this._playlist.switchSubtitle(n),l.next=3,this._manifestLoader.stopPoll();case 3:return l.next=5,this._refreshM3U8();case 5:case"end":return l.stop()}},i,this)}));function t(i){return e.apply(this,arguments)}return t}()},{key:"detachMedia",value:function(){var e=H(A().mark(function i(){return A().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(!this._bufferService){s.next=3;break}return s.next=3,this._bufferService.detachMedia();case 3:case"end":return s.stop()}},i,this)}));function t(){return e.apply(this,arguments)}return t}()},{key:"destroy",value:function(){var e=H(A().mark(function i(){var n;return A().wrap(function(l){for(;;)switch(l.prev=l.next){case 0:if(this.media){l.next=2;break}return l.abrupt("return");case 2:return this.removeAllListeners(),this._playlist.reset(),this._segmentLoader.reset(),(n=this._seiService)===null||n===void 0||n.reset(),this.media.removeEventListener("loadeddata",this._onLoadeddata),this.media.removeEventListener("play",this._onPlay),this.media.removeEventListener("pause",this._onPause),this.media.removeEventListener("seeking",this._onSeeking),this.media.removeEventListener("timeupdate",this._onTimeupdate),l.next=13,Promise.all([this._clear(),this._bufferService.destroy()]);case 13:this.media=null;case 14:case"end":return l.stop()}},i,this)}));function t(){return e.apply(this,arguments)}return t}()},{key:"_loadM3U8",value:function(){var e=H(A().mark(function i(n){var s,l,o,h,c,v,f;return A().wrap(function(S){for(;;)switch(S.prev=S.next){case 0:if(S.prev=0,h=(l=this.config.manifestList)===null||l===void 0||(o=l.filter(function(m){return m.url===n})[0])===null||o===void 0?void 0:o.manifest,!h){S.next=6;break}S.t0=this._manifestLoader.parseText(h,n),S.next=9;break;case 6:return S.next=8,this._manifestLoader.load(n);case 8:S.t0=S.sent;case 9:c=S.t0,v=ue(c,1),s=v[0],S.next=17;break;case 14:throw S.prev=14,S.t1=S.catch(0),this._emitError(J.create(S.t1));case 17:if(s){S.next=19;break}return S.abrupt("return");case 19:if(this._playlist.upsertPlaylist(s),!s.isMaster){S.next=24;break}return(f=this._playlist.currentStream.subtitleStreams)!==null&&f!==void 0&&f.length&&this.emit(G.SUBTITLE_PLAYLIST,{list:this._playlist.currentStream.subtitleStreams}),S.next=24,this._refreshM3U8();case 24:return this.emit(G.STREAM_PARSED),S.abrupt("return",s);case 26:case"end":return S.stop()}},i,this,[[0,14]])}));function t(i){return e.apply(this,arguments)}return t}()},{key:"_refreshM3U8",value:function(){var t,i,n=this,s=this._playlist.currentStream;if(!s||!s.url)throw this._emitError(J.create(null,null,new Error("m3u8 url is not defined")));var l=s.url,o=(t=s.currentAudioStream)===null||t===void 0?void 0:t.url,h=(i=s.currentSubtitleStream)===null||i===void 0?void 0:i.url;return this._manifestLoader.load(l,o,h).then(function(c){var v=ue(c,3),f=v[0],d=v[1],S=v[2];f&&(n._playlist.upsertPlaylist(f,d,S),n.isLive&&n._pollM3U8(l,o,h))}).catch(function(c){throw n._emitError(J.create(c))})}},{key:"_pollM3U8",value:function(t,i,n){var s=this,l=this._playlist.isEmpty,o;if(this._playlist.lowLatency)o=(this._playlist.currentStream.partTargetDuration||0)*1e3;else{var h;o=(((h=this._playlist.lastSegment)===null||h===void 0?void 0:h.duration)||0)*1e3}this._manifestLoader.poll(t,i,n,function(c,v,f){s._playlist.upsertPlaylist(c,v,f),s._playlist.clearOldSegment();var d=c&&l&&!s._playlist.isEmpty;(d||!s._playlist.hadSegmentLoaded&&s._playlist.nbSegments>=s.config.minSegmentsStartPlay)&&s._loadSegment(),l&&(l=s._playlist.isEmpty)},function(c){s._emitError(J.create(c))},o)}},{key:"_loadSegmentDirect",value:function(){var e=H(A().mark(function i(n){var s,l,o,h,c,v;return A().wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(s=this._playlist.nextSegment,s){d.next=3;break}return d.abrupt("return");case 3:return l=!1,o=null,d.prev=5,this._segmentProcessing=!0,Z.log("load segment, sn:".concat(s.sn,", [").concat(s.start,", ").concat(s.end,"], partIndex:").concat(s.partIndex)),d.next=10,this._reqAndBufferSegment(s,this._playlist.getAudioSegment(s));case 10:l=d.sent,d.next=16;break;case 13:d.prev=13,d.t0=d.catch(5),o=d.t0;case 16:return d.prev=16,this._segmentProcessing=!1,d.finish(16);case 19:if(!o){d.next=26;break}if(!this._bufferService.isFull()){d.next=25;break}return Z.log("load segment, sn:".concat(s.sn,", partIndex:").concat(s.partIndex)),this._segmentProcessing=!0,this._isProcessQuotaExceeded=!0,d.abrupt("return",!1);case 25:return d.abrupt("return",this._emitError(J.create(o)));case 26:return l&&(c=this.bufferInfo().end,this.isLive&&!this.media.seeking&&c&&Math.abs(s.end-c)>1&&(Z.warn("segment: ".concat(s.sn," expected end=").concat(s.end,", real end=").concat(c)),this._playlist.feedbackLiveEdge(s,c)),v=((h=this._playlist.currentStream)===null||h===void 0?void 0:h.url)===s.parentUrl,this._urlSwitching&&!v&&(Z.warn("pre playlist segment appended!"),this._bufferService.seamlessSwitch()),this.isLive&&this._urlSwitching&&v&&(this._urlSwitching=!1,this.emit(G.SWITCH_URL_SUCCESS,{url:this.config.url})),this._playlist.moveSegmentPointer(),s.isLast?this._end():n||this._loadSegment()),d.abrupt("return",l);case 28:case"end":return d.stop()}},i,this,[[5,13,16,19]])}));function t(i){return e.apply(this,arguments)}return t}()},{key:"_reqAndBufferSegment",value:function(){var e=H(A().mark(function i(n,s){var l,o,h,c,v,f,d,S,m,g,D;return A().wrap(function(E){for(;;)switch(E.prev=E.next){case 0:return o=n?n.cc:s.cc,h=this._prevSegCc!==o,c=[],E.prev=3,E.next=6,this._segmentLoader.load(n,s,h);case 6:c=E.sent,E.next=14;break;case 9:throw E.prev=9,E.t0=E.catch(3),E.t0.fatal=!1,this._segmentLoader.error=E.t0,E.t0;case 14:if(c[0]){E.next=16;break}return E.abrupt("return");case 16:return E.next=18,(l=this._bufferService).decryptBuffer.apply(l,ar(c));case 18:if(v=E.sent,v){E.next=21;break}return E.abrupt("return");case 21:return f=n?n.sn:s.sn,d=n?n.start:s.start,S=this._playlist.currentStream,this._bufferService.createSource(v[0],v[1],S==null?void 0:S.videoCodec,S==null?void 0:S.audioCodec),m=Date.now(),g=this._prevSegSn===f-1,this.isLive&&this._urlSwitching&&(D=this.bufferInfo().end,this._playlist.updateSegmentsRanges(f,D),Z.warn("update the new playlist liveEdge, segment id=".concat(f,", buffer start=").concat(D,", liveEdge=").concat(this._playlist.liveEdge)),d=D),E.next=30,this._bufferService.appendBuffer(n,s,v[0],v[1],h,g,d);case 30:return this.emit(G.APPEND_COST,{elapsed:Date.now()-m,url:n.url}),E.next=33,this._bufferService.evictBuffer(this.config.bufferBehind);case 33:return this._prevSegCc=o,this._prevSegSn=f,E.abrupt("return",!0);case 36:case"end":return E.stop()}},i,this,[[3,9]])}));function t(i,n){return e.apply(this,arguments)}return t}()},{key:"_onCheckQuotaExceeded",value:function(){var e=H(A().mark(function i(){var n,s,l,o,h,c;return A().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:n=this.media.currentTime,s=this.media.buffered,l=!1,o=0;case 4:if(!(o<s.length)){f.next=11;break}if(!(s.start(0)>=n&&n<s.end(o))){f.next=8;break}return l=!0,f.abrupt("break",11);case 8:o++,f.next=4;break;case 11:if(!this._bufferService.isFull()){f.next=17;break}if(h=l?this.config.bufferBehind:5,c=this.media.currentTime,!(c-h>0)){f.next=17;break}return f.next=17,this._bufferService.removeBuffer(0,c-h);case 17:case"end":return f.stop()}},i,this)}));function t(){return e.apply(this,arguments)}return t}()},{key:"_checkStreamTrackChange",value:function(t){var i=this._playlist.checkSegmentTrackChange(t,this._bufferService.nbSb);i&&this.switchURL(this.config.url,i.start+.2)}},{key:"_clear",value:function(){var e=H(A().mark(function i(){return A().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return clearTimeout(this._disconnectTimer),this._stopTick(),s.next=4,Promise.all([this._segmentLoader.cancel(),this._manifestLoader.stopPoll()]);case 4:this._segmentProcessing=!1;case 5:case"end":return s.stop()}},i,this)}));function t(){return e.apply(this,arguments)}return t}()},{key:"_reset",value:function(){var e=H(A().mark(function i(){var n,s,l=arguments;return A().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:return s=l.length>0&&l[0]!==void 0?l[0]:!1,this._reloadOnPlay=!1,this._prevSegSn=null,this._prevSegCc=null,this._switchUrlOpts=null,this._playlist.reset(),this._segmentLoader.reset(),(n=this._seiService)===null||n===void 0||n.reset(),this._stats.reset(),h.next=11,this._clear();case 11:return h.abrupt("return",this._bufferService.reset(s));case 12:case"end":return h.stop()}},i,this)}));function t(){return e.apply(this,arguments)}return t}()},{key:"_end",value:function(){this._clear(),this._bufferService.endOfStream(),(this.media.readyState<=2||this.media.buffered.length>1)&&this._startTick()}},{key:"_stopTick",value:function(){this._tickTimer&&clearTimeout(this._tickTimer),this._tickTimer=null}},{key:"_startTick",value:function(){this._stopTick(),this._tickTimer=setTimeout(this._tick,this._tickInterval)}},{key:"_emitError",value:function(t){var i,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(((i=t.originError)===null||i===void 0?void 0:i.fatal)===!1)Z.warn(t);else{var s,l,o;Z.table(t),Z.error(t),Z.error((s=this.media)===null||s===void 0?void 0:s.error),(l=this.media)!==null&&l!==void 0&&l.readyState&&this.media.pause(),this._stopTick(),this._urlSwitching&&(this._urlSwitching=!1,this.emit(G.SWITCH_URL_FAILED,t)),this.emit(G.ERROR,t),n&&this._end(),(o=this._seiService)===null||o===void 0||o.reset()}return t}},{key:"_getSeamlessSwitchPoint",value:function(){var t=this.media,i=t.currentTime;if(!t.paused){var n,s=this._playlist.findSegmentIndexByTime(t.currentTime),l=this._playlist.getSegmentByIndex(s),o=(n=this._stats)===null||n===void 0?void 0:n.getStats().downloadSpeed;if(o&&l){var h=l.duration*this._playlist.currentStream.bitrate/o+1;i+=h}else i+=5}return i}},{key:"_tryEos",value:function(){var t,i,n=this.media,s=this._playlist,l=s.nextSegment,o=s.lastSegment,h=(!l||o&&fe.isBuffered(n,o.start+o.duration/2))&&n.readyState&&n.duration>0&&((t=this._bufferService)===null||t===void 0?void 0:t.msIsOpened)&&!((i=this._bufferService)!==null&&i!==void 0&&i.msHasOpTasks);if(h){var c=this.bufferInfo();n.paused&&!n.currentTime&&(c=this.bufferInfo(c.nextStart||.5));var v=Math.abs(c.end-n.duration)<.1||!this.isLive&&o&&c.end>=o.start+o.duration;v&&this._bufferService.endOfStream()}}}],[{key:"isSupported",value:function(t){return!t||t==="video"||t==="audio"?ee.isSupported():typeof WebAssembly<"u"}},{key:"enableLogger",value:function(){ye.enable(),tt.enable()}},{key:"disableLogger",value:function(){ye.disable(),tt.disable()}}]),r}(Bt);p(Se,"version","3.0.21");try{localStorage.getItem("xgd")?Se.enableLogger():Se.disableLogger()}catch{}var Wr=function(){function u(a,r){var e=this;Q(this,u),p(this,"_opts",null),p(this,"_plugin",null),p(this,"_onLowDecode",function(){var t,i,n,s,l=e._opts,o=l.media,h=l.innerDegrade;(t=e._plugin)===null||t===void 0||(i=t.player)===null||i===void 0||i.emit("lowdecode",o.degradeInfo),(n=e._plugin)===null||n===void 0||(s=n.player)===null||s===void 0||s.emit("core_event",Y(Y({},o.degradeInfo),{},{eventName:G.LOWDECODE})),h===1&&e._degrade(o.src)}),p(this,"_degrade",function(t){var i=e._plugin.player,n=i.video;if(!(n&&n.TAG!=="MVideo")){var s=i.video.degradeVideo;i.video=s,n.degrade(t),t&&(i.config.url=t);var l=i.root.firstChild;l.TAG==="MVideo"&&i.root.replaceChild(s,l);var o=e._plugin.constructor.pluginName.toLowerCase();i.unRegisterPlugin(o),i.once("canplay",function(){i.play()})}}),p(this,"forceDegradeToVideo",function(t){var i=e._opts.innerDegrade;i===1&&e._degrade(t)}),this._opts=a,this._plugin=r,this._init()}return $(u,[{key:"_init",value:function(){var r=this._opts,e=r.media,t=r.preloadTime,i=r.innerDegrade,n=r.isLive;if(e){if(!n&&e.setPlayMode){e.setPlayMode("VOD");return}i&&e.setAttribute("innerdegrade",i),t&&e.setAttribute("preloadtime",t),this._bindEvents()}}},{key:"_bindEvents",value:function(){var r=this._opts.media;r.addEventListener("lowdecode",this._onLowDecode)}},{key:"destroy",value:function(){var r,e;(r=this._opts)===null||r===void 0||(e=r.media)===null||e===void 0||e.removeEventListener("lowdecode",this._onLowDecode),this._plugin=null}}]),u}(),qr=["currentTime"];function Qr(u,a){var r=a.player,e=r.currentTime,t={startTime:e};switch(ke(u)){case"boolean":t.seamless=u;break;case"object":{var i=u.currentTime,n=nt(u,qr);Object.assign(t,n),typeof i=="number"&&(t.startTime=i);break}}return t}var Mt=function(u){Oe(r,u);var a=Me(r);function r(){var e;Q(this,r);for(var t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return e=a.call.apply(a,[this].concat(i)),p(N(e),"logger",Z),p(N(e),"hls",null),p(N(e),"pluginExtension",null),p(N(e),"getStats",function(){var s;return(s=e.hls)===null||s===void 0?void 0:s.getStats()}),p(N(e),"_onSwitchSubtitle",function(s){var l,o=s.lang;(l=e.hls)===null||l===void 0||l.switchSubtitleStream(o)}),p(N(e),"_keepPauseStatus",function(){var s=e.player.paused;s&&e.player.once("canplay",function(){e.player.pause()})}),e}return $(r,[{key:"core",get:function(){return this.hls}},{key:"version",get:function(){var t;return(t=this.hls)===null||t===void 0?void 0:t.version}},{key:"softDecode",get:function(){var t,i,n=(t=this.player)===null||t===void 0||(i=t.config)===null||i===void 0?void 0:i.mediaType;return!!n&&n!=="video"&&n!=="audio"&&n!=="offscreen-video"}},{key:"beforePlayerInit",value:function(){var t=this,i=this.player.config,n=this.player.media||this.player.video,s=i.hls||{};if(!(!i.url&&!i.__allowHlsEmptyUrl__||!this.softDecode&&!s.preferMMS&&ee.isMMSOnly())){this.hls&&this.hls.destroy();var l=Object.getOwnPropertyDescriptor(this.player,"switchURL");(!l||l.writable)&&(this.player.switchURL=function(c,v){return new Promise(function(f,d){var S=t.player,m=t.hls;if(m){var g,D,b=Qr(v,t);S.config.url=c,m.switchURL(c,b).then(function(){return f(!0)}).catch(d),!b.seamless&&(g=t.player.config)!==null&&g!==void 0&&(D=g.hls)!==null&&D!==void 0&&D.keepStatusAfterSwitch&&t._keepPauseStatus()}else d()})});var o=this.player.switchURL;if(this.player.handleSource=!1,s.innerDegrade=s.innerDegrade||i.innerDegrade,(s.disconnectTime===null||s.disconnectTime===void 0)&&(s.disconnectTime=0),this.hls=new Se(Y({softDecode:this.softDecode,isLive:i.isLive,media:n,startTime:i.startTime,url:i.url},s)),this.softDecode||ht.defineGetterOrSetter(this.player,{url:{get:function(){var v,f;return(v=t.hls)===null||v===void 0||(f=v.media)===null||f===void 0?void 0:f.src},configurable:!0}}),this.softDecode&&(this.pluginExtension=new Wr(Y({isLive:i.isLive,media:n},s),this),this.player.forceDegradeToVideo=function(){for(var c,v=arguments.length,f=new Array(v),d=0;d<v;d++)f[d]=arguments[d];return(c=t.pluginExtension)===null||c===void 0?void 0:c.forceDegradeToVideo.apply(c,f)}),i.isLive){var h;(h=this.player)===null||h===void 0||h.useHooks("replay",function(){var c;return(c=t.hls)===null||c===void 0?void 0:c.replay()})}this.on(Ut,o),this.on(Nt,this._onSwitchSubtitle),this.on(xt,this.destroy.bind(this)),this._transError(),this._transCoreEvent(x.TTFB),this._transCoreEvent(x.LOAD_START),this._transCoreEvent(x.LOAD_RESPONSE_HEADERS),this._transCoreEvent(x.LOAD_COMPLETE),this._transCoreEvent(x.LOAD_RETRY),this._transCoreEvent(x.SOURCEBUFFER_CREATED),this._transCoreEvent(x.MEDIASOURCE_OPENED),this._transCoreEvent(x.APPEND_BUFFER),this._transCoreEvent(x.REMOVE_BUFFER),this._transCoreEvent(x.BUFFEREOS),this._transCoreEvent(x.KEYFRAME),this._transCoreEvent(x.METADATA_PARSED),this._transCoreEvent(x.DEMUXED_TRACK),this._transCoreEvent(x.SEI),this._transCoreEvent(x.SEI_IN_TIME),this._transCoreEvent(x.SPEED),this._transCoreEvent(x.HLS_MANIFEST_LOADED),this._transCoreEvent(x.HLS_LEVEL_LOADED),this._transCoreEvent(x.STREAM_EXCEPTION),this._transCoreEvent(x.SWITCH_URL_SUCCESS),this._transCoreEvent(x.SWITCH_URL_FAILED),this._transCoreEvent(G.NO_AUDIO_TRACK),this._transCoreEvent(G.STREAM_PARSED),this._transCoreEvent(G.SUBTITLE_SEGMENTS),this._transCoreEvent(G.SUBTITLE_PLAYLIST),this._transCoreEvent(G.APPEND_COST),i.url&&this.hls.load(i.url,{reuseMse:!0}).catch(function(c){})}}},{key:"destroy",value:function(){var t;this.hls&&(this.hls.destroy(),this.hls=null),(t=this.pluginExtension)===null||t===void 0||t.destroy(),this.pluginExtension=null}},{key:"_transError",value:function(){var t=this;this.hls.on(G.ERROR,function(i){t.player&&t.player.emit(Ft,new Vt(t.player,i))})}},{key:"_transCoreEvent",value:function(t){var i=this;this.hls.on(t,function(n){i.player&&(i.player.emit("core_event",Y(Y({},n),{},{eventName:t})),t===x.SEI_IN_TIME&&i.hls.hasSubtitle&&i._emitSeiPaylodTime(n))})}},{key:"_emitSeiPaylodTime",value:function(t){try{var i=JSON.parse(Array.from(t.data.payload).map(function(n){return String.fromCharCode(n)}).join("").slice(0,-1));if(!i.rtmp_dts)return;this.player.emit("core_event",{eventName:G.SEI_PAYLOAD_TIME,time:i.rtmp_dts})}catch{}}}],[{key:"pluginName",get:function(){return"hls"}},{key:"isSupported",value:function(t,i){return Se.isSupported(t,i)}}]),r}(ht);p(Mt,"Hls",Se);p(Mt,"EVENT",G);export{ie as ERR,ri as ERR_CODE,G as EVENT,Se as Hls,Mt as HlsPlugin,jr as ManifestLoader,Kr as Playlist,Xr as SegmentLoader,J as StreamingError,Mt as default,Ar as getConfig,Z as logger,Qr as parseSwitchUrlArgs};
