{"version":3,"file":"location-picker.vue2.mjs","sources":["../../../../../../packages/components/location-picker/src/location-picker.vue"],"sourcesContent":["<template>\r\n  <div class=\"liv-location-picker\">\r\n    <el-form\r\n      :inline=\"true\"\r\n      :model=\"form\"\r\n      ref=\"formRef\"\r\n      class=\"liv-location-picker__form\"\r\n      :rules=\"rules\"\r\n      v-bind=\"$attrs\">\r\n      <el-form-item prop=\"search\" label=\"输入关键字\">\r\n        <el-input\r\n          v-model=\"search\"\r\n          placeholder=\"请输入关键字\"\r\n          clearable\r\n          @change=\"handleSearch\"></el-input>\r\n      </el-form-item>\r\n      <el-form-item prop=\"0\" label=\"经度\">\r\n        <el-input\r\n          v-model.number=\"form[0]\"\r\n          placeholder=\"请输入经度\"\r\n          clearable\r\n          type=\"number\"\r\n          @mousewheel.native.prevent></el-input>\r\n      </el-form-item>\r\n      <el-form-item prop=\"1\" label=\"纬度\">\r\n        <el-input\r\n          v-model.number=\"form[1]\"\r\n          placeholder=\"请输入纬度\"\r\n          clearable\r\n          type=\"number\"\r\n          @mousewheel.native.prevent></el-input>\r\n      </el-form-item>\r\n      <el-form-item>\r\n        <el-button type=\"primary\" @click=\"handleConfirm\">确定</el-button>\r\n      </el-form-item>\r\n    </el-form>\r\n    <div class=\"liv-location-picker__map\">\r\n      <liv-a-map\r\n        class=\"liv-location-picker__map-container\"\r\n        v-bind=\"propsProxy\"\r\n        @loaded=\"mapLoaded\"></liv-a-map>\r\n      <div id=\"panel\" class=\"liv-location-picker__search-panel\"></div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script lang=\"ts\" setup>\r\nimport { inject, ref, watch, watchEffect } from 'vue';\r\nimport type { LocationPickerEmits, LocationPickerProps } from './location-picker';\r\nimport { ElForm, ElFormItem, ElButton, ElInput, type FormInstance } from 'element-plus';\r\nimport { getPropsPoxy, validateLatitude, validateLongitude } from '@liv-web/utils';\r\nimport LivAMap from '../../a-map/src/a-map.vue';\r\nimport { LOCATION_PICKER_KEY } from '@liv-web/constants';\r\nimport gcoord from 'gcoord';\r\nimport { clone } from 'lodash-es';\r\n\r\n/**\r\n * 组件配置\r\n */\r\ndefineOptions({\r\n  name: 'LivLocationPicker',\r\n});\r\n\r\n/**\r\n * 注入全局属性\r\n */\r\nconst globalProps = inject<LocationPickerProps>(LOCATION_PICKER_KEY, {});\r\n\r\n/**\r\n * 组件属性\r\n */\r\nconst props = withDefaults(defineProps<LocationPickerProps>(), {\r\n  type: () => 'gcj02',\r\n});\r\n\r\n/**\r\n * 属性代理\r\n */\r\nconst propsProxy = getPropsPoxy<LocationPickerProps>(props, globalProps);\r\n\r\n/**\r\n * 组件事件\r\n */\r\nconst emit = defineEmits<LocationPickerEmits>();\r\n\r\n/**\r\n * 表单实例\r\n */\r\nconst formRef = ref<FormInstance>();\r\n\r\n/**\r\n * 表单数据模型\r\n */\r\nconst form = ref<(number | null)[]>([null, null]);\r\n\r\n/**\r\n * 搜索关键字\r\n */\r\nconst search = ref('');\r\n\r\n/**\r\n * 坐标系映射表\r\n */\r\nconst coordinateMap = {\r\n  wgs84: gcoord.WGS84,\r\n  gcj02: gcoord.GCJ02,\r\n};\r\n\r\n/**\r\n * 组件双向绑定值\r\n */\r\nconst model = defineModel<(number | null)[]>({\r\n  default: [null, null],\r\n});\r\n\r\n/**\r\n * 经度双向绑定\r\n */\r\nconst longitude = defineModel<number | null>('longitude', {\r\n  default: null,\r\n});\r\n\r\n/**\r\n * 纬度双向绑定\r\n */\r\nconst latitude = defineModel<number | null>('latitude', {\r\n  default: null,\r\n});\r\n\r\n/**\r\n * 地址双向绑定\r\n */\r\nconst address = defineModel<string | null>('address', {\r\n  default: null,\r\n});\r\n\r\n/**\r\n * 表单校验规则\r\n */\r\nconst rules = {\r\n  0: [\r\n    { required: true, message: '请输入经度', trigger: 'blur' },\r\n    { validator: validateLongitude, trigger: 'blur' },\r\n  ],\r\n  1: [\r\n    { required: true, message: '请输入纬度', trigger: 'blur' },\r\n    { validator: validateLatitude, trigger: 'blur' },\r\n  ],\r\n};\r\n\r\n/**\r\n * 地图实例\r\n */\r\nlet map: AMap.Map | null = null;\r\n\r\n/**\r\n * 高德地图实例\r\n */\r\nlet AMap: AMap.NameSpace | null = null;\r\n\r\n/**\r\n * 搜索插件实例\r\n */\r\nlet placeSearch: any = null;\r\n\r\n/**\r\n * 地理编码插件实例\r\n */\r\nlet geocoder: any = null;\r\n\r\n/**\r\n * 标记点实例\r\n */\r\nlet marker: AMap.Marker | null = null;\r\n\r\n/**\r\n * 表单form值变化同步更新marker位置\r\n */\r\nwatchEffect(() => {\r\n  if (form.value[0] && form.value[1]) {\r\n    UpdateMarker(form.value[0], form.value[1]);\r\n  }\r\n});\r\n\r\n/**\r\n * 表单form值变化后触发change事件\r\n */\r\nwatch(form, (newValue, oldValue) => {\r\n  if (newValue[0] !== oldValue[0] || newValue[1] !== oldValue[1]) {\r\n    emit('change', [form.value[0], form.value[1]]);\r\n  }\r\n});\r\n\r\n/**\r\n * 绑定值修改后同步修改表单form值\r\n */\r\nwatch(model, () => {\r\n  form.value = clone(model.value);\r\n  if (model.value && model.value[0] && model.value[1]) {\r\n    const targetPoint = convertToOriginCoordinate([model.value[0], model.value[1]]);\r\n    map?.setCenter(targetPoint, true);\r\n    geocoder?.getAddress(targetPoint, (status: string, result: any) => {\r\n      if (status === 'complete' && result.info === 'OK') {\r\n        address.value = result.regeocode.formattedAddress;\r\n      } else {\r\n        console.error('[liv-web/location-picker]逆地理编码失败！', result);\r\n      }\r\n    });\r\n  } else {\r\n    address.value = '';\r\n  }\r\n});\r\n\r\n/**\r\n * 处理确认按钮点击事件\r\n */\r\nfunction handleConfirm() {\r\n  formRef.value?.validate(valid => {\r\n    if (valid) {\r\n      model.value = clone(form.value);\r\n      longitude.value = form.value[0];\r\n      latitude.value = form.value[1];\r\n      emit('confirm', [form.value[0]!, form.value[1]!]);\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * 地图加载完成回调\r\n */\r\nfunction mapLoaded(mapInstance: AMap.Map, AMapInstance: AMap.NameSpace) {\r\n  map = mapInstance;\r\n  AMap = AMapInstance;\r\n  form.value = clone(model.value);\r\n  if (model.value && model.value[0] && model.value[1]) {\r\n    map?.setCenter(convertToOriginCoordinate([model.value[0], model.value[1]]), true);\r\n  }\r\n  map.on('click', e => {\r\n    form.value = convertToTargetCoordinate([e.lnglat.getLng(), e.lnglat.getLat()]);\r\n  });\r\n  AMap.plugin(['AMap.PlaceSearch', 'AMap.Geocoder'], function () {\r\n    //@ts-ignore\r\n    placeSearch = new AMap.PlaceSearch({\r\n      pageSize: 5,\r\n      pageIndex: 1,\r\n      citylimit: true,\r\n      map: map,\r\n      panel: 'panel',\r\n      autoFitView: true,\r\n    });\r\n    AMap?.Event.addListener(placeSearch, 'markerClick', function (e: any) {\r\n      form.value = convertToTargetCoordinate([e.data.location.lng, e.data.location.lat]);\r\n    });\r\n    AMap?.Event.addListener(placeSearch, 'listElementClick', function (e: any) {\r\n      form.value = convertToTargetCoordinate([e.data.location.lng, e.data.location.lat]);\r\n    });\r\n    //@ts-ignore\r\n    geocoder = new AMap.Geocoder({\r\n      radius: 1000,\r\n      extensions: 'all',\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * 更新标记点位置\r\n * @param longitude 经度\r\n * @param latitude 纬度\r\n */\r\nfunction UpdateMarker(longitude: number, latitude: number) {\r\n  if (marker) {\r\n    marker.setPosition(convertToOriginCoordinate([longitude, latitude]));\r\n  } else {\r\n    if (AMap) {\r\n      marker = new AMap.Marker({\r\n        icon: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',\r\n        position: convertToOriginCoordinate([longitude, latitude]),\r\n        anchor: 'bottom-center',\r\n        zIndex: 9999,\r\n      });\r\n      marker.setMap(map);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 处理搜索框输入事件，根据关键字进行地图搜索\r\n */\r\nfunction handleSearch() {\r\n  if (search.value) {\r\n    placeSearch.search(search.value);\r\n  } else {\r\n    placeSearch.clear();\r\n  }\r\n}\r\n\r\n/**\r\n * 将经纬度坐标转换为目标坐标系，即组件type属性设置的坐标系\r\n * @param lnglat 需要转换的经纬度坐标\r\n */\r\nfunction convertToTargetCoordinate(lnglat: [number, number]) {\r\n  return gcoord.transform(lnglat, coordinateMap.gcj02, coordinateMap[propsProxy.type!]);\r\n}\r\n\r\n/**\r\n * 将经纬度坐标转换为源坐标系，即高德地图的gcj02坐标系\r\n * @param lnglat 需要转换的经纬度坐标\r\n */\r\nfunction convertToOriginCoordinate(lnglat: [number, number]) {\r\n  return gcoord.transform(lnglat, coordinateMap[propsProxy.type!], coordinateMap.gcj02);\r\n}\r\n</script>\r\n"],"names":["_useModel","longitude","latitude"],"mappings":"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"}